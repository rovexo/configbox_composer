var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,g,f){a instanceof String&&(a=String(a));for(var d=a.length,b=0;b<d;b++){var h=a[b];if(g.call(f,h,b,a))return{i:b,v:h}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,f){a!=Array.prototype&&a!=Object.prototype&&(a[g]=f.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var g=0;g<a.length;++g){var f=a[g];if(f&&f.Math==Math)return f}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,g,f,d){if(g){f=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var b=a[d];b in f||(f[b]={});f=f[b]}a=a[a.length-1];d=f[a];g=g(d);g!=d&&null!=g&&$jscomp.defineProperty(f,a,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,f){return $jscomp.findInternal(this,a,f).v}},"es6","es3");
define(["cbj","kenedo","configbox/server","cbj.ui","cbj.dragtable"],function(a,g,f){var d={initMatrixViewEach:function(){a(".view-admincalcmatrix:not(.each-processing-done)").each(function(){var b=a(this);b.find(".calc-matrix").dragtable({items:".column-parameter .column-sort-handle",boundary:":not(.column-parameter)"});b.find(".calc-matrix tbody").sortable({appendTo:"parent",items:"tr:not(.column-parameters)",helper:"clone",handle:".row-sort-handle",placeholder:"ui-state-highlight",axis:"y",start:function(b,
c){a(c.helper).find("td").each(function(){var b=a(this).index();b=a(this).closest(".calc-matrix").find(".column-parameters th").eq(b).outerWidth();a(this).outerWidth(b)})}});b.addClass("each-processing-done")})},initMatrixViewOnce:function(){g.setFormTaskHandler("admincalculation",d.taskHandler);a(document).on("click",".view-admincalcmatrix .toggle-matrix-tools",d.onShowMatrixTools);a(document).on("click",".view-admincalcmatrix .trigger-show-file-browser",d.onShowFileBrowser);a(document).on("change",
".spreadsheet-upload-input",d.onUploadSpreadsheet);a(document).on("click",".axis-parameter-picker .tab",d.onAxisPickerTabClick);a(document).on("click",".view-admincalcmatrix .cell-axis-parameter .kenedo-popup-trigger-content",d.onAxisPickerOpenerClick);a(document).on("change",".axis-parameter-picker .question-picker",d.onQuestionPicked);a(document).on("change",".axis-parameter-picker .calculation-picker",d.onCalculationPicked);a(document).on("click",".axis-parameter-picker .trigger-disable-axis",
d.onDisableAxis);a(document).on("click",".view-admincalcmatrix .trigger-add-row",d.addRow);a(document).on("click",".view-admincalcmatrix .trigger-add-column",d.addColumn);a(document).on("click",".view-admincalcmatrix .trigger-remove",d.onColumnOrRowRemove)},onShowMatrixTools:function(){a(this).toggleClass("active").closest(".matrix-wrapper-table").toggleClass("show-matrix-tools")},onAxisPickerTabClick:function(){a(this).addClass("tab-open").siblings().removeClass("tab-open");var b=a(this).attr("id").replace("tab-",
"");a(this).closest(".axis-parameter-picker").find("#pane-"+b).addClass("pane-open").siblings().removeClass("pane-open")},onAxisPickerOpenerClick:function(){a(this).closest(".kenedo-popup-trigger").find(".kenedo-popup").fadeOut(200,function(){a(this).css("visible","hidden")});a(this).closest(".kenedo-popup-trigger").trigger("popup-close")},onColumnOrRowRemove:function(){if(a(this).closest(".column-parameter").length){var b=a(this).closest("th").index();a(".calc-matrix tr").each(function(){a(this).find("th:nth-child("+
(b+1)+")").remove();a(this).find("td:nth-child("+(b+1)+")").remove()})}else a(this).closest("tr").remove()},onCalculationPicked:function(){var b=a(this).val(),h=a(this).find("option[value="+b+"]").text(),c=0!==a(this).closest(".column-parameter-picker").length?"column":"row";"column"===c?(a("#column_type").val("calculation"),a("#column_element_id").val("0").trigger("chosen:updated").trigger("change"),a("#column_calc_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-column").show()):
(a("#row_type").val("calculation"),a("#row_element_id").val("0").trigger("chosen:updated").trigger("change"),a("#row_calc_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-row").show());"column"===c?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-calculation").show().find(".parameter-title").text(h)):(a(".cell-row-parameter").find(".axis-label").hide(),a(".cell-row-parameter").find(".label-calculation").show().find(".parameter-title").text(h));
var e='<i class="dragtable-drag-handle row-sort-handle fa fa-reorder"></i>';e+='<input class="input-value" type="text" value="" />';e+='<span class="trigger-remove"></span>';a("row"===c?".row-parameter":".column-parameter").each(function(){0===a(this).find("input[type=text]").length&&a(this).html(e)});a(this).closest(".kenedo-popup").hide()},onQuestionPicked:function(){var b=a(this).val(),h=a(this);f.makeRequest("ajaxapi","getAnswerDropdownData",{question_id:b}).done(function(c){var e=0!==h.closest(".column-parameter-picker").length?
"column":"row";"column"===e?(a("#column_type").val("question"),a("#column_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#column_element_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-column").show()):(a("#row_type").val("question"),a("#row_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#row_element_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-row").show());var d=h.find("option[value="+b+"]").text(),f="";"column"===
e?(a(".cell-column-parameter").find(".axis-label").hide(),f+='<i class="dragtable-drag-handle column-sort-handle fa fa-reorder"></i>'):(a(".cell-row-parameter").find(".axis-label").hide(),f+='<i class="dragtable-drag-handle row-sort-handle fa fa-reorder"></i>');var g=0;a.each(c,function(){g++});1<g?("column"===e?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-answers").show().find(".parameter-title").text(d)):(a(".cell-row-parameter").find(".axis-label").hide(),
a(".cell-row-parameter").find(".label-answers").show().find(".parameter-title").text(d)),f+="<select>",a.each(c,function(a,b){f+='<option value="'+a+'">'+b+"</option>"}),f+="</select>"):("column"===e?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-textfield").show().find(".parameter-title").text(d)):(a(".cell-row-parameter").find(".axis-label").hide(),a(".cell-row-parameter").find(".label-textfield").show().find(".parameter-title").text(d)),f+='<input class="input-value" type="text" value="" />');
f+='<span class="trigger-remove"></span>';var l=1;a("row"===e?".row-parameter":".column-parameter").each(function(){1<g?a(this).html(f):0===a(this).find("input[type=text]").length&&a(this).html(f);0!==a(this).find("select").length&&(a(this).find("select option:nth-child("+l+")").prop("selected",!0),l++)});h.closest(".kenedo-popup").hide()})},addRow:function(){a(".calc-matrix tr:last").clone().appendTo(".calc-matrix");a(".calc-matrix tr:last .input-value").val("");a(".calc-matrix tr:last .price").val("")},
addColumn:function(){a(".calc-matrix thead tr:first-child").find("th:last").clone().appendTo(a(".calc-matrix thead tr:first-child")).find("input").val("");a(".calc-matrix tbody tr").each(function(){a(this).find("td:last").clone().appendTo(a(this)).find("input").val("")})},onDisableAxis:function(){var b=0!==a(this).closest(".column-parameter-picker").length?"column":"row";"column"===b?(a("#column_type").val("none"),a("#column_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#column_element_id").val("0").trigger("chosen:updated").trigger("change"),
a(".cell-column-parameter .label-none").show().siblings(".axis-label").hide()):(a("#row_type").val("none"),a("#row_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#row_element_id").val("0").trigger("chosen:updated").trigger("change"),a(".cell-row-parameter .label-none").show().siblings(".axis-label").hide());"column"===b?a(".calc-matrix td, .calc-matrix th").each(function(){1<a(this).index()&&a(this).remove()}):a(".calc-matrix tbody tr").each(function(){0<a(this).index()&&a(this).remove()});
"column"===b?(a(".column-parameter").html('<input class="input-value" type="hidden" value="0" />'),a(".trigger-add-column").hide()):(a(".row-parameter").html('<input class="input-value" type="hidden" value="0" />'),a(".trigger-add-row").hide())},onShowFileBrowser:function(){a(this).closest(".view-admincalcmatrix").find(".spreadsheet-upload-input").click()},onUploadSpreadsheet:function(b){b.preventDefault();b.stopPropagation();var h=a(this);b=h[0].files;if(1===b.length&&b.length){var c=new FormData,
e={option:"com_configbox",controller:"admincalcmatrices",task:"getMatrixDataFromSpreadsheet",format:"json"},g;for(g in e)e.hasOwnProperty(g)&&c.append(g,e[g]);c.append("file",b[0]);var k=new XMLHttpRequest;k.addEventListener("readystatechange",function(){h.val("");if(k.readyState===XMLHttpRequest.DONE){var a=JSON.parse(k.responseText);!0===a.success?d.updateMatrix(a.data):window.alert(a.message)}});k.open("post",f.config.urlXhr,!0);k.send(c)}else window.alert("Please upload at least one file only.")},
updateMatrix:function(b){var h=a(".calc-matrix");var c=h.find("tbody tr").length+1;var e=b.length;if(e){if(c>e)for(e=c-e,c=0;c<e;c++)h.find("tbody tr:last-child th .trigger-remove").trigger("click");else if(c<e)for(e-=c,c=0;c<e;c++)d.addRow();c=h.find("thead th").length;e=b[0].length;if(c>e)for(e=c-e,c=0;c<e;c++)h.find("thead th:last-child .trigger-remove").trigger("click");else if(c<e)for(e-=c,c=0;c<e;c++)d.addColumn();a.each(b,function(b,c){a.each(c,function(a,c){if("number"===typeof c||"string"===
typeof c)c=String(c),c=c.replace(",",""),c=c.replace(".",f.config.decimalSymbol);0==b?h.find("thead th:nth-child("+(a+1)+") input[type=text]").val(c):0==a?h.find("tbody tr:nth-child("+b+") th input[type=text]").val(c):h.find("tbody tr:nth-child("+b+") td:nth-child("+(a+1)+") input[type=text]").val(c)})});window.setTimeout(function(){h.find("td").addClass("flash");h.find(".input-value").addClass("flash")},100);window.setTimeout(function(){h.find("td").removeClass("flash");h.find(".input-value").removeClass("flash")},
1600)}},taskHandler:function(b,d,c){if("close"===d||"cancel"===d)return g.defaultFormTaskHandler(b,"cancel",c);if(0===a(".view-admincalcmatrix").length)return g.defaultFormTaskHandler(b,d,c);a(".calc-matrix .missing-value, .calc-matrix .invalid").removeClass("missing-value").removeClass("invalid");var e=[],h=[],k=!1,m=!1;a(".calc-matrix .column-parameter").each(function(){var b="";a(this).find("select").length&&(b=a(this).find("select").val());a(this).find("input").length&&(b=a(this).find("input").val());
b?-1!==e.indexOf(b)?(a(this).addClass("duplicate-value"),m=!0):e.push(b):(a(this).addClass("missing-value"),k=!0)});a(".calc-matrix .row-parameter").each(function(){var b="";a(this).find("select").length&&(b=a(this).find("select").val());a(this).find("input").length&&(b=a(this).find("input").val());b?-1!==h.indexOf(b)?(a(this).addClass("duplicate-value"),m=!0):h.push(b):(a(this).addClass("missing-value"),k=!0)});if(m)return window.alert("You have some duplicate parameter values, please check your row and column headers"),
!1;if(k)return!1;var l=[],n=0,p=1,q=!0;a(".calc-matrix tr:not(.column-parameters)").each(function(){var b=0;a(this).find(".price").each(function(){var c=a(this).val();c?(c=c.replace(f.config.thousandsSeparator,""),c=c.replace(f.config.decimalSymbol,"."),!0===isNaN(parseFloat(c))&&(a(this).addClass("invalid"),q=!1)):c=0;l.push({x:e[b],y:h[n],value:c,ordering:p});b++;p++});n++});if(!1===q)return window.alert("One or more values appear like invalid numbers. Please check"),!1;a("#matrix").val(JSON.stringify(l));
return g.defaultFormTaskHandler(b,d,c)}};return d});
