var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,g,e){a instanceof String&&(a=String(a));for(var f=a.length,b=0;b<f;b++){var h=a[b];if(g.call(e,h,b,a))return{i:b,v:h}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,e){a!=Array.prototype&&a!=Object.prototype&&(a[g]=e.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var g=0;g<a.length;++g){var e=a[g];if(e&&e.Math==Math)return e}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,g,e,f){if(g){e=$jscomp.global;a=a.split(".");for(f=0;f<a.length-1;f++){var b=a[f];b in e||(e[b]={});e=e[b]}a=a[a.length-1];f=e[a];g=g(f);g!=f&&null!=g&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,e){return $jscomp.findInternal(this,a,e).v}},"es6","es3");
define(["cbj","kenedo","configbox/server","cbj.ui","cbj.dragtable"],function(a,g,e){var f={initMatrixViewEach:function(){a(".view-admincalcmatrix:not(.each-processing-done)").each(function(){var b=a(this);b.find(".calc-matrix").dragtable({items:".column-parameter .column-sort-handle",boundary:":not(.column-parameter)"});b.find(".calc-matrix tbody").sortable({appendTo:"parent",items:"tr:not(.column-parameters)",helper:"clone",handle:".row-sort-handle",placeholder:"ui-state-highlight",axis:"y",start:function(b,
c){a(c.helper).find("td").each(function(){var b=a(this).index();b=a(this).closest(".calc-matrix").find(".column-parameters th").eq(b).outerWidth();a(this).outerWidth(b)})}});b.addClass("each-processing-done")})},initMatrixViewOnce:function(){a(document).on("click",".view-admincalcmatrix .toggle-matrix-tools",f.onShowMatrixTools);a(document).on("click",".view-admincalcmatrix .trigger-show-file-browser",f.onShowFileBrowser);a(document).on("change",".spreadsheet-upload-input",f.onUploadSpreadsheet);
a(document).on("click",".axis-parameter-picker .tab",f.onAxisPickerTabClick);a(document).on("click",".view-admincalcmatrix .cell-axis-parameter .kenedo-popup-trigger-content",f.onAxisPickerOpenerClick);a(document).on("change",".axis-parameter-picker .question-picker",f.onQuestionPicked);a(document).on("change",".axis-parameter-picker .calculation-picker",f.onCalculationPicked);a(document).on("click",".axis-parameter-picker .trigger-disable-axis",f.onDisableAxis);a(document).on("click",".view-admincalcmatrix .trigger-add-row",
f.addRow);a(document).on("click",".view-admincalcmatrix .trigger-add-column",f.addColumn);a(document).on("click",".view-admincalcmatrix .trigger-remove",f.onColumnOrRowRemove)},onShowMatrixTools:function(){a(this).toggleClass("active").closest(".matrix-wrapper-table").toggleClass("show-matrix-tools")},onAxisPickerTabClick:function(){a(this).addClass("tab-open").siblings().removeClass("tab-open");var b=a(this).attr("id").replace("tab-","");a(this).closest(".axis-parameter-picker").find("#pane-"+b).addClass("pane-open").siblings().removeClass("pane-open")},
onAxisPickerOpenerClick:function(){a(this).closest(".kenedo-popup-trigger").find(".kenedo-popup").fadeOut(200,function(){a(this).css("visible","hidden")});a(this).closest(".kenedo-popup-trigger").trigger("popup-close")},onColumnOrRowRemove:function(){if(a(this).closest(".column-parameter").length){var b=a(this).closest("th").index();a(".calc-matrix tr").each(function(){a(this).find("th:nth-child("+(b+1)+")").remove();a(this).find("td:nth-child("+(b+1)+")").remove()})}else a(this).closest("tr").remove()},
onCalculationPicked:function(){var b=a(this).val(),h=a(this).find("option[value="+b+"]").text(),c=0===a(this).closest(".column-parameter-picker").length?"row":"column";"column"===c?(a("#column_type").val("calculation"),a("#column_element_id").val("0").trigger("chosen:updated").trigger("change"),a("#column_calc_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-column").show()):(a("#row_type").val("calculation"),a("#row_element_id").val("0").trigger("chosen:updated").trigger("change"),
a("#row_calc_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-row").show());"column"===c?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-calculation").show().find(".parameter-title").text(h)):(a(".cell-row-parameter").find(".axis-label").hide(),a(".cell-row-parameter").find(".label-calculation").show().find(".parameter-title").text(h));var d='<i class="dragtable-drag-handle row-sort-handle fa fa-bars"></i>';d+='<input class="input-value" type="text" value="" />';
d+='<span class="trigger-remove fa fa-times"></span>';a("row"===c?".row-parameter":".column-parameter").each(function(){0===a(this).find("input[type=text]").length&&a(this).html(d)});a(this).closest(".kenedo-popup").hide()},onQuestionPicked:function(){var b=a(this).val(),h=a(this);e.makeRequest("ajaxapi","getAnswerDropdownData",{question_id:b}).done(function(c){var d=0===h.closest(".column-parameter-picker").length?"row":"column";"column"===d?(a("#column_type").val("question"),a("#column_calc_id").val("0").trigger("chosen:updated").trigger("change"),
a("#column_element_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-column").show()):(a("#row_type").val("question"),a("#row_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#row_element_id").val(b).trigger("chosen:updated").trigger("change"),a(".trigger-add-row").show());var f=h.find("option[value="+b+"]").text(),e="";"column"===d?(a(".cell-column-parameter").find(".axis-label").hide(),e+='<i class="dragtable-drag-handle column-sort-handle fa fa-bars"></i>'):
(a(".cell-row-parameter").find(".axis-label").hide(),e+='<i class="dragtable-drag-handle row-sort-handle fa fa-bars"></i>');var g=0;a.each(c,function(){g++});1<g?("column"===d?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-answers").show().find(".parameter-title").text(f)):(a(".cell-row-parameter").find(".axis-label").hide(),a(".cell-row-parameter").find(".label-answers").show().find(".parameter-title").text(f)),e+="<select>",a.each(c,function(a,b){e+=
'<option value="'+a+'">'+b+"</option>"}),e+="</select>"):("column"===d?(a(".cell-column-parameter").find(".axis-label").hide(),a(".cell-column-parameter").find(".label-textfield").show().find(".parameter-title").text(f)):(a(".cell-row-parameter").find(".axis-label").hide(),a(".cell-row-parameter").find(".label-textfield").show().find(".parameter-title").text(f)),e+='<input class="input-value" type="text" value="" />');e+='<span class="trigger-remove fa fa-times"></span>';var l=1;a("row"===d?".row-parameter":
".column-parameter").each(function(){1<g?a(this).html(e):0===a(this).find("input[type=text]").length&&a(this).html(e);0!==a(this).find("select").length&&(a(this).find("select option:nth-child("+l+")").prop("selected",!0),l++)});h.closest(".kenedo-popup").hide()})},addRow:function(){a(".calc-matrix tr:last").clone().appendTo(".calc-matrix");a(".calc-matrix tr:last .input-value").val("");a(".calc-matrix tr:last .price").val("")},addColumn:function(){a(".calc-matrix thead tr:first-child").first().find("th").last().clone().appendTo(a(".calc-matrix thead tr").first()).find("input").val("");
a(".calc-matrix tbody tr").each(function(){a(this).find("td").last().clone().appendTo(a(this)).find("input").val("")})},onDisableAxis:function(){var b=0===a(this).closest(".column-parameter-picker").length?"row":"column";"column"===b?(a("#column_type").val("none"),a("#column_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#column_element_id").val("0").trigger("chosen:updated").trigger("change"),a(".cell-column-parameter .label-none").show().siblings(".axis-label").hide()):(a("#row_type").val("none"),
a("#row_calc_id").val("0").trigger("chosen:updated").trigger("change"),a("#row_element_id").val("0").trigger("chosen:updated").trigger("change"),a(".cell-row-parameter .label-none").show().siblings(".axis-label").hide());"column"===b?a(".calc-matrix td, .calc-matrix th").each(function(){1<a(this).index()&&a(this).remove()}):a(".calc-matrix tbody tr").each(function(){0<a(this).index()&&a(this).remove()});"column"===b?(a(".column-parameter").html('<input class="input-value" type="hidden" value="0" />'),
a(".trigger-add-column").hide()):(a(".row-parameter").html('<input class="input-value" type="hidden" value="0" />'),a(".trigger-add-row").hide())},onShowFileBrowser:function(){a(this).closest(".view-admincalcmatrix").find(".spreadsheet-upload-input").click()},onUploadSpreadsheet:function(b){b.preventDefault();b.stopPropagation();var h=a(this);b=h[0].files;if(1===b.length&&b.length){var c=new FormData,d={option:"com_configbox",controller:"admincalcmatrices",task:"getMatrixDataFromSpreadsheet",output_mode:"view_only"},
g;for(g in d)d.hasOwnProperty(g)&&c.append(g,d[g]);c.append("file",b[0]);var k=new XMLHttpRequest;k.addEventListener("readystatechange",function(){h.val("");if(k.readyState===XMLHttpRequest.DONE){var a=JSON.parse(k.responseText);!0===a.success?f.updateMatrix(a.data):window.alert(a.message)}});k.open("post",e.config.urlXhr,!0);k.send(c)}else window.alert("Please upload at least one file only.")},updateMatrix:function(b){var h=a(".calc-matrix");var c=h.find("tbody tr").length+1;var d=b.length;if(d){if(c>
d)for(d=c-d,c=0;c<d;c++)h.find("tbody tr:last-child th .trigger-remove").trigger("click");else if(c<d)for(d-=c,c=0;c<d;c++)f.addRow();c=h.find("thead th").length;d=b[0].length;if(c>d)for(d=c-d,c=0;c<d;c++)h.find("thead th:last-child .trigger-remove").trigger("click");else if(c<d)for(d-=c,c=0;c<d;c++)f.addColumn();a.each(b,function(b,c){a.each(c,function(a,c){if("number"===typeof c||"string"===typeof c)c=String(c),c=c.replace(",",""),c=c.replace(".",e.config.decimalSymbol);0==b?h.find("thead th:nth-child("+
(a+1)+") input[type=text]").val(c):0==a?h.find("tbody tr:nth-child("+b+") th input[type=text]").val(c):h.find("tbody tr:nth-child("+b+") td:nth-child("+(a+1)+") input[type=text]").val(c)})});window.setTimeout(function(){h.find("td").addClass("flash");h.find(".input-value").addClass("flash")},100);window.setTimeout(function(){h.find("td").removeClass("flash");h.find(".input-value").removeClass("flash")},1600)}},onStoreMatrix:function(b){var e=a(this),c=e.data("task"),d=e.closest(".kenedo-details-form"),
p=d.data("view");b={btn:e,task:c,form:d,viewName:p,event:b};g.setFormParameter(d,"task",c);c=d.find(".view-admincalcmatrix");c=f.getMatrixJson(c);!1!==c&&(d.find("input[name=matrix]").val(c),d.trigger("cbFormTaskTriggered",b))},getMatrixJson:function(b){b.find(".calc-matrix .missing-value, .calc-matrix .invalid").removeClass("missing-value").removeClass("invalid");var f=[],c=[],d=!1,g=!1;b.find(".calc-matrix .column-parameter").each(function(){var b="";a(this).find("select").length&&(b=a(this).find("select").val());
a(this).find("input").length&&(b=a(this).find("input").val());b?-1===f.indexOf(b)?f.push(b):(a(this).addClass("duplicate-value"),g=!0):(a(this).addClass("missing-value"),d=!0)});b.find(".calc-matrix .row-parameter").each(function(){var b="";a(this).find("select").length&&(b=a(this).find("select").val());a(this).find("input").length&&(b=a(this).find("input").val());b?-1===c.indexOf(b)?c.push(b):(a(this).addClass("duplicate-value"),g=!0):(a(this).addClass("missing-value"),d=!0)});if(g)return window.alert("You have some duplicate parameter values, please check your row and column headers"),
!1;if(d)return!1;var k=[],m=0,l=1,n=!0;b.find(".calc-matrix tr:not(.column-parameters)").each(function(){var b=0;a(this).find(".price").each(function(){var d=a(this).val();d?(d=d.replace(e.config.thousandsSeparator,""),d=d.replace(e.config.decimalSymbol,"."),!0===isNaN(parseFloat(d))&&(a(this).addClass("invalid"),n=!1)):d=0;k.push({x:f[b],y:c[m],value:d,ordering:l});b++;l++});m++});return!1===n?(window.alert("One or more values appear like invalid numbers. Please check"),!1):JSON.stringify(k)}};return f});
