define(["cbj"],function(a){var e={initConfiguratorPage:function(){a(document).on("serverResponseReceived",this.processServerResponse);a(document).on("cbRequiredSelectionsMissing",this.onRequiredSelectionsMissing);a(document).on("cbRequiredSelectionsMade",this.onRequiredSelectionsMade);a(document).on("change","#currency_id",this.onChangeCurrency);a(document).on("cbSelectionChange",this.blockPricing.updateSelection);a(document).on("cbSelectionChange",this.blockVisualization.updateVisualization);a(document).on("cbPricingChange",
this.blockPricing.updatePricing);a(document).on("cbPricingChange",this.updateAnswerPrices);a(document).on("cbPricingChange",this.updatePricingInConfiguratorData);a(document).on("click",".configurator-page-title",this.blockPricing.toggleSelectionsVisibility);a(document).on("click",".trigger-show-page-edit-buttons",this.showPageEditButtons);a(document).on("click",".trigger-hide-page-edit-buttons",this.hidePageEditButtons);a(document).on("cbQuestionActivation",this.onQuestionActivation);a(document).on("cbQuestionDeactivation",
this.onQuestionDeactivation);a(document).on("cbAnswerActivation",this.onAnswerActivation);a(document).on("cbAnswerDeactivation",this.onAnswerDeactivation);this.initDeferredPageNav();this.initSelectionImageSwitcher()},initConfiguratorPageEach:function(){this.initQuestions();this.initImagePreloading();this.initStickyBlock();this.initBsPopovers()},showPageEditButtons:function(){a(".trigger-show-page-edit-buttons").hide();a(".page-edit-buttons").show()},hidePageEditButtons:function(){a(".trigger-show-page-edit-buttons").show();
a(".page-edit-buttons").hide()},updatePricingInConfiguratorData:function(a,b){e.setConfiguratorDataItem("pricing",b)},onQuestionActivation:function(c,b){a("#question-"+b).removeClass("non-applying-question").addClass("applying-question")},onQuestionDeactivation:function(c,b){a("#question-"+b).addClass("non-applying-question").removeClass("applying-question")},onAnswerActivation:function(c,b,d){a("#answer-"+d).removeClass("non-applying-answer").addClass("applying-answer")},onAnswerDeactivation:function(c,
b,d){a("#answer-"+d).addClass("non-applying-answer").removeClass("applying-answer")},onRequiredSelectionsMissing:function(){!0===e.getConfiguratorData("blockNavigationOnMissing")&&a(".add-to-cart-button, .cb-page-nav-next").addClass("configbox-disabled")},onRequiredSelectionsMade:function(){a(".add-to-cart-button, .cb-page-nav-next").removeClass("configbox-disabled")},onChangeCurrency:function(){a(this).closest("form").submit()},registeredQuestionTypes:{},registerQuestion:function(a,b){var d="init onQuestionActivation onQuestionDeactivation onAnswerActivation onAnswerDeactivation onSystemSelectionChange onValidationChange onValidationMessageShown onValidationMessageCleared".split(" "),
f=[],g;for(g in d)d.hasOwnProperty(g)&&"function"!==typeof b[d[g]]&&f.push(d[g]);if(f.length)throw'Your question type "'+a+'" is missing these methods: '+f.join(", ")+". Add them and try again, even if you do not need those. Look up what they do in the built-in question types.";e.registeredQuestionTypes[a]=b},getQuestionType:function(a){return this.registeredQuestionTypes[a]},initQuestions:function(){cbrequire(["configbox/questions","configbox/custom/custom_questions"],function(){var c=[];a(".kenedo-view.view-configuratorpage .question").each(function(){var b=
a(this).data("questionType");if(!b)throw'The configurator page contains a question without a data-question-type attribute. Compare with the built-in question type templates and add it. The question with the problem has the ID "'+a(this).attr("id")+'"';var d=e.getQuestionType(b);if(!d)throw'The configurator page contains a question of type "'+b+'", but type object is not registered. Make sure you make and register it in custom_questions.js';d.initEach&&d.initEach();-1===c.indexOf(b)&&(c.push(b),d.init(),
a(document).on("cbQuestionActivation",d.onQuestionActivation),a(document).on("cbQuestionDeactivation",d.onQuestionDeactivation),a(document).on("cbAnswerActivation",d.onAnswerActivation),a(document).on("cbAnswerDeactivation",d.onAnswerDeactivation),a(document).on("cbSystemSelectionChange",d.onSystemSelectionChange),a(document).on("cbValidationChange",d.onValidationChange),a(document).on("cbValidationMessageShown",d.onValidationMessageShown),a(document).on("cbValidationMessageCleared",d.onValidationMessageCleared))})})},
initBsPopovers:function(){a(".cb-popover").length&&cbrequire(["cbj","cbj.bootstrap"],function(a){a(".cb-popover").each(function(){var b={trigger:"undefined"!==typeof a(this).data("trigger")?a(this).data("trigger"):"hover",delay:"undefined"!==typeof a(this).data("delay")?a(this).data("delay"):200,html:"undefined"!==typeof a(this).data("html")?a(this).data("html"):!0};a(this).popover(b)});a(document).on("focus",function(){a(".cb-popover").popover("hide")})})},initSelectionImageSwitcher:function(){a(document).on("click",
".trigger-show-visualization",function(){a(".overviews").addClass("show-visualization").removeClass("show-selections")});a(document).on("click",".trigger-show-selections",function(){a(".overviews").addClass("show-selections").removeClass("show-visualization")})},initStickyBlock:function(){if(0!==a(".sticky-block").length){var c=a(".sticky-block"),b=c.offset(),d=c.height(),f=0,g=!1;!0!==e.stickyBlockHandlersAttached&&(e.stickyBlockHandlersAttached=!0,window.setInterval(function(){d=c.height();b=c.offset();
var e=null;c.closest(".row").children().each(function(){null!==e&&e!==a(this).offset().top&&(g=!0);e=a(this).offset().top;a(this).innerHeight()>f&&!a(this).find(".overviews").length&&(f=a(this).innerHeight())})},200),a(window).scroll(function(){if(0!==c.length)if(!0===g)c.css("padding-top",0);else{var e=a(window).scrollTop();e+20>b.top?(e=e-b.top+20,e+d<f-20&&c.css("padding-top",e),c.closest(".row").width()===c.width()&&c.css("padding-top",0)):c.css("padding-top",0)}}))}},initDeferredPageNav:function(){var c,
b;a(document).on("click",".wait-for-xhr",function(d){e.redirectUrl="";!0===c&&(d.preventDefault(),d.stopImmediatePropagation(),b=a(this).attr("href"))});a(document).ajaxStart(function(){c=!0});a(document).ajaxStop(function(){c=!1;b&&(window.location.href=b)})},initImagePreloading:function(){var c=function(b){b||(b=a(".cb-content"));b.find(".preload-image").each(function(b,d){var c=a(d).data("src");d.src!==c&&(d.src=c)})},b=window.setTimeout(c,500);a(document).ajaxStart(function(){window.clearTimeout(b)});
a(document).ajaxStop(function(){b=window.setTimeout(c,500)});a("img:not(.preload-image)").on("load",function(){window.clearTimeout(b);b=window.setTimeout(c,500)});a(document).on("cbQuestionActivation cbAnswerActivation",function(b,f){c(a("#question-"+f))})},sendSelectionToServer:function(c,b,d){e.blockVisualization.updateVisualization(c,parseInt(b));cbrequire(["configbox/server"],function(f){var g={languageTag:f.config.languageTag,questionId:c,selection:b,confirmed:d?"1":"0",cart_position_id:e.getCartPositionId(),
productId:e.getProductId(),pageId:e.getPageId()};f.makeRequest("configuratorpage","makeSelection",g).done(function(b){a(document).trigger("serverResponseReceived",[b])})})},processServerResponse:function(c,b){"undefined"!==typeof b.error?e.showValidationError(b.requestedChange.questionId,b.error):(e.clearValidationError(b.requestedChange.questionId),b.confirmationText?window.confirm(b.confirmationText)?e.sendSelectionToServer(b.requestedChange.questionId,b.requestedChange.selection,!0):e.updateSelection(b.originalValue.questionId,
b.originalValue.selection,b.originalValue.outputValue,"system"):(b.requestedChange&&e.updateSelection(b.requestedChange.questionId,b.requestedChange.selection,b.requestedChange.outputValue,"user"),b.validationValues&&e.processValidationUpdate(b.validationValues),b.itemVisibility&&e.processItemVisibility(b.itemVisibility),b.configurationChanges&&e.processAutomaticSelections(b.configurationChanges),b.pricing&&a(document).trigger("cbPricingChange",[b.pricing]),b.missingSelections.length?a(document).trigger("cbRequiredSelectionsMissing",
[b.missingSelections]):a(document).trigger("cbRequiredSelectionsMade")))},showValidationError:function(c,b){a(document).trigger("cbValidationMessageShown",[c,b])},clearValidationError:function(c){a(document).trigger("cbValidationMessageCleared",[c])},updateSelection:function(c,b,d,f){"undefined"===typeof f&&(f="user");if("user"!==f&&"system"!==f)throw"selectedBy parameter is neither 'user' nor 'system'. Was '"+f+"'";a("#question-"+c).data("selection",b);a("#question-"+c).data("outputValue",d);"system"===
f&&a(document).trigger("cbSystemSelectionChange",[c,b,d]);a(document).trigger("cbSelectionChange",[c,b,d])},processValidationUpdate:function(c){a.each(c,function(b,d){a(document).trigger("cbValidationChange",[b,d])})},processItemVisibility:function(c){var b=e.getConfiguratorData("questions");a.each(c.questions,function(d,c){b[d].applies!==c&&((b[d].applies=c)?a(document).trigger("cbQuestionActivation",[d]):a(document).trigger("cbQuestionDeactivation",[d]))});a.each(c.answers,function(d,c){a.each(c,
function(c,f){b[d].answers[c].applies!==f&&((b[d].answers[c].applies=f)?a(document).trigger("cbAnswerActivation",[d,c]):a(document).trigger("cbAnswerDeactivation",[d,c]))})})},processAutomaticSelections:function(c){c.remove&&a.each(c.remove,function(a){e.updateSelection(a,null,null,"system")});c.add&&a.each(c.add,function(a,c){e.updateSelection(a,c.selection,c.outputValue,"system")})},updateAnswerPrices:function(c,b){a.each(b.questions,function(b,c){a(".question-price-"+b).html(c.priceFormatted);
0===c.price?a(".question-price-"+b).closest(".question-price-wrapper").hide():a(".question-price-"+b).closest(".question-price-wrapper").show();a(".question-price-recurring-"+b).html(c.priceRecurringFormatted);0===c.priceRecurring?a(".question-price-recurring-"+b).closest(".question-price-recurring-wrapper").hide():a(".question-price-recurring-"+b).closest(".question-price-recurring-wrapper").show()});a.each(b.answers,function(b,c){a(".answer-price-"+b).html(c.priceFormatted);0===c.price?a(".answer-price-"+
b).closest(".answer-price-wrapper").hide():a(".answer-price-"+b).closest(".answer-price-wrapper").show();a(".answer-price-recurring-"+b).html(c.priceRecurringFormatted);0===c.priceRecurring?a(".answer-price-recurring-"+b).closest(".answer-price-recurring-wrapper-recurring").hide():a(".answer-price-recurring-"+b).closest(".answer-price-recurring-wrapper").show()})},getCurrentSelection:function(c){return a("#question-"+c).data("selection")},getCartPositionId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("cart-position-id"))},
getProductId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("product-id"))},getPageId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("page-id"))},getConfiguratorData:function(c){var b=a("#configurator-data").data("json");if(c){if("undefined"===typeof b[c])throw'Could not find key "'+c+'" in configurator data.';return b[c]}return b},replaceConfiguratorData:function(c){a("#configurator-data").data("json",c)},setConfiguratorDataItem:function(c,b){a("#configurator-data").data("json")[c]=
b},questionHasProperty:function(a,b){return"undefined"!==typeof e.getConfiguratorData("questions")[a][b]},getQuestionPropValue:function(a,b){var d=e.getConfiguratorData("questions");if("undefined"===typeof d[a])throw'Question ID "'+a+'" does not exist';if("undefined"===typeof d[a][b])throw'Questions do not have property "'+b+'"';return d[a][b]},blockPricing:{toggleSelectionsVisibility:function(){a(this).closest(".no-questions").length||(a(this).find(".pricing-configurator-page").slideToggle(100),
a(this).closest(".configurator-page").find(".question-list").slideToggle(100,function(){a(this).closest(".configurator-page").toggleClass("configurator-page-expanded")}))},updatePricing:function(c,b){a(".pricing-regular .item-quantity").html(b.quantity);a(".pricing-recurring .item-quantity").html(b.quantity);a(".pricing-regular .pricing-per-item-total").html(b.total.pricePerItemFormatted);a(".pricing-recurring .pricing-per-item-total").html(b.total.pricePerItemRecurringFormatted);a(".pricing-regular .pricing-total").html(b.total.priceFormatted);
a(".pricing-recurring .pricing-total").html(b.total.priceRecurringFormatted);a.each(b.pages,function(b,c){var e=0!==c.price?c.priceFormatted:"";a(".pricing-regular .pricing-configurator-page-"+b).html(e);e=c.priceRecurring?c.priceRecurringFormatted:"";a(".pricing-recurring .pricing-configurator-page-"+b).html(e)});a.each(b.questions,function(b,c){var e=0!==c.price?c.priceFormatted:"";a(".pricing-regular .pricing-question-"+b).html(e);e=0!==c.priceRecurring?c.priceRecurringFormatted:"";a(".pricing-recurring .pricing-question-"+
b).html(e)});a(".pricing-regular .pricing-per-item-net").html(b.total.pricePerItemNetFormatted);a(".pricing-regular .pricing-per-item-tax").html(b.total.pricePerItemTaxFormatted);a(".pricing-regular .pricing-per-item-gross").html(b.total.pricePerItemGrossFormatted);a(".pricing-recurring .pricing-per-item-net").html(b.total.pricePerItemRecurringNetFormatted);a(".pricing-recurring .pricing-per-item-tax").html(b.total.pricePerItemRecurringTaxFormatted);a(".pricing-recurring .pricing-per-item-gross").html(b.total.pricePerItemRecurringGrossFormatted);
a(".pricing-regular .pricing-total-net").html(b.total.priceNetFormatted);a(".pricing-regular .pricing-total-tax").html(b.total.priceTaxFormatted);a(".pricing-regular .pricing-total-gross").html(b.total.priceGrossFormatted);a(".pricing-recurring .pricing-total-net").html(b.total.priceRecurringNetFormatted);a(".pricing-recurring .pricing-total-tax").html(b.total.priceRecurringTaxFormatted);a(".pricing-recurring .pricing-total-gross").html(b.total.priceRecurringGrossFormatted);a(".pricing-total-plus-extras-net").html(b.totalPlusExtras.priceTaxFormatted);
a(".pricing-total-plus-extras-tax").html(b.totalPlusExtras.priceNetFormatted);a(".pricing-total-plus-extras-gross").html(b.totalPlusExtras.priceGrossFormatted);b.taxesFormatted&&a.each(b.taxesFormatted,function(b,c){a(".pricing-regular .pricing-taxrate-"+String(b).replace(".","-")).html(c)});b.delivery&&(a(".best-delivery-title").text(b.delivery.title),a(".pricing-total-delivery-net").html(b.delivery.priceNetFormatted),a(".pricing-total-delivery-tax").html(b.delivery.priceTaxFormatted),a(".pricing-total-delivery-gross").html(b.delivery.priceGrossFormatted),
a(".delivery-cost").each(function(){0===b.delivery.priceGross?a(this).slideUp():a(this).slideDown()}));b.payment&&(a(".best-payment-title").text(b.payment.title),a(".pricing-total-payment-net").html(b.payment.priceNetFormatted),a(".pricing-total-payment-tax").html(b.payment.priceTaxFormatted),a(".pricing-total-payment-gross").html(b.payment.priceGrossFormatted),a(".payment-cost").each(function(){0===b.payment.priceGross?a(this).slideUp():a(this).slideDown()}));a(".pricing-quantity").text(b.quantity);
1<b.quantity?(a(".total-per-item").each(function(){"none"===a(this).css("display")&&a(this).slideDown(100)}),a(".quantity-display").each(function(){"none"===a(this).css("display")&&a(this).slideDown(100)})):(a(".total-per-item").each(function(){"none"!==a(this).css("display")&&a(this).slideUp(100)}),a(".quantity-display").each(function(){"none"!==a(this).css("display")&&a(this).slideUp(100)}))},updateSelection:function(c,b,d,e){d?(a(".question-item-outputvalue-"+b).html(e),a(".hidden-item.question-item-"+
b).slideDown(100,function(){a(this).removeClass("hidden-item")})):a(".question-item-"+b).slideUp(100,function(){a(this).addClass("hidden-item")})}},blockVisualization:{updateVisualization:function(a,b,d){d?e.blockVisualization.changeImage(b,d):e.blockVisualization.removeImage(b)},removeImage:function(c){a(".image-question-id-"+c).fadeOut(200)},changeImage:function(c,b){if(parseInt(b)==b)if(b=parseInt(b),0!==b)if(0===a(".image-answer-id-"+b).length)a(".image-question-id-"+c+":not(.image-answer-id-"+
b+")").fadeOut(200);else{a(".image-answer-id-"+b).fadeIn(200,"linear");var d=a(".image-question-id-"+c+":not(.image-answer-id-"+b+")");d.length&&d.fadeOut(200,"linear")}else a(".image-answer-id-"+b).fadeOut(200)}}};return e});
