define(["cbj","configbox/server"],function(a,h){var d={initConfiguratorPage:function(){a(document).on("serverResponseReceived",this.processServerResponse);a(document).on("cbRequiredProductSelectionsMissing",this.onRequiredProductSelectionsMissing);a(document).on("cbRequiredProductSelectionsMade",this.onRequiredProductSelectionsMade);a(document).on("cbRequiredPageSelectionsMissing",this.onRequiredPageSelectionsMissing);a(document).on("cbRequiredPageSelectionsMade",this.onRequiredPageSelectionsMade);
a(document).on("change","#currency_id",this.onChangeCurrency);a(document).on("cbSelectionChange",this.blockPricing.updateSelection);a(document).on("cbSelectionChange",this.blockVisualization.updateVisualization);a(document).on("cbPricingChange",this.blockPricing.updatePricing);a(document).on("cbPricingChange",this.updateAnswerPrices);a(document).on("cbPricingChange",this.updatePricingInConfiguratorData);a(document).on("click",".configurator-page-title",this.blockPricing.toggleSelectionsVisibility);
a(document).on("click",".trigger-add-to-cart",this.onAddToCart);a(document).on("click",".trigger-show-page-edit-buttons",this.showPageEditButtons);a(document).on("click",".trigger-hide-page-edit-buttons",this.hidePageEditButtons);a(document).on("cbQuestionActivation",this.onQuestionActivation);a(document).on("cbQuestionDeactivation",this.onQuestionDeactivation);a(document).on("cbAnswerActivation",this.onAnswerActivation);a(document).on("cbAnswerDeactivation",this.onAnswerDeactivation);"magento2"===
h.config.platformName&&(a(document).on("cbPricingChange",this.updateMagento2Total),this.initMagento2Validation());a(document).on("serverRequestSent",function(){d.requestInProgress=!0});a(document).on("serverResponseReceived",function(){d.requestInProgress=!1});this.initDeferredPageNav();this.initSelectionImageSwitcher();this.initPageNavigation()},requestInProgress:!1,initConfiguratorPageEach:function(){this.initQuestions();this.initImagePreloading();this.initStickyBlock();this.initBsPopovers()},onAddToCart:function(c){c.preventDefault();
c.stopPropagation();var b=a(this);c=function(){if(!b.hasClass("processing")){b.addClass("processing");var a={cartPositionId:d.getCartPositionId()};h.makeRequest("configuratorpage","getMissingSelections",a).done(function(c){if(0!==c.length){var g=parseInt(c[0].pageId);g!==d.getPageId()?d.switchPage(g,function(){d.addValidationErrors(c)}):d.addValidationErrors(c);b.removeClass("processing")}else h.makeRequest("configuratorpage","addConfigurationToCart",a).done(function(a){!0===a.success?window.location.href=
a.redirectUrl:alert(a.feedback)}).always(function(){b.removeClass("processing")})})}};if(d.requestInProgress)a(document).on("serverResponseReceived",c);else c()},addValidationErrors:function(c){a.each(c,function(a,c){d.showValidationError(c.id,c.message)})},initPageNavigation:function(){window.addEventListener("popstate",function(a){a&&a.state&&a.state.cbPageId&&d.switchPage(a.state.cbPageId)});a(document).on("click",".cb-page-nav-prev, .cb-page-nav-next, .cb-tab-nav-link",function(c){if(!0===a(this).hasClass("configbox-disabled"))c.preventDefault();
else{var b=a(this).attr("href"),e,f=(a(this).attr("class")||"").split(" "),g;for(g in f)!0===f.hasOwnProperty(g)&&-1!==f[g].indexOf("page-id-")&&(e=f[g].replace("page-id-",""),e=parseInt(e));e?(c.preventDefault(),window.history.pushState({cbPageId:e},"",b),d.switchPage(e)):console.log("No page ID found in link classes. Skipping ajax switch")}})},switchPage:function(c,b){0===a(".configurator-page-wrapper").length&&a(".kenedo-view.view-configuratorpage").wrap('<div class="configurator-page-wrapper"></div>');
h.injectHtml(".configurator-page-wrapper","configuratorpage","getPageHtml",{pageId:c},function(){var c=a(".kenedo-view.view-configuratorpage").offset().top,f=a(window).scrollTop(),c=c-("undefined"===typeof window.stickyHeaderHeight?50:window.stickyHeaderHeight);c<f&&a("html, body").animate({scrollTop:c},500);"function"==typeof b&&b()})},initMagento2Validation:function(){window.require(["jquery","mage/validation"],function(c){c.validator.addMethod("configbox_m2_validation",function(b,c){var f=d.getConfiguratorData("missingProductSelections");
if(0===f.length){var g=d.getConfiguratorData("questions");a.each(g,function(){d.clearValidationError(this.id)});return!0}g=parseInt(f[0].pageId);g!==d.getPageId()?d.switchPage(g,function(){d.addValidationErrors(f)}):d.addValidationErrors(f);return!1},"")})},updateMagento2Total:function(c,b){var e=b.total.price,f=b.total.priceNet,d=a("#wrapper-cb-option").data("option-id");window.require(["jquery"],function(a){var b={};b["options["+d+"]"]={oldPrice:{amount:f,adjustments:[]},basePrice:{amount:f},finalPrice:{amount:e}};
a(".price-box").trigger("updatePrice",b)})},showPageEditButtons:function(){a(".trigger-show-page-edit-buttons").hide();a(".page-edit-buttons").show()},hidePageEditButtons:function(){a(".trigger-show-page-edit-buttons").show();a(".page-edit-buttons").hide()},updatePricingInConfiguratorData:function(a,b){d.setConfiguratorDataItem("pricing",b)},onQuestionActivation:function(c,b){a("#question-"+b).removeClass("non-applying-question").addClass("applying-question")},onQuestionDeactivation:function(c,b){a("#question-"+
b).addClass("non-applying-question").removeClass("applying-question")},onAnswerActivation:function(c,b,e){a("#answer-"+e).removeClass("non-applying-answer").addClass("applying-answer")},onAnswerDeactivation:function(c,b,e){a("#answer-"+e).addClass("non-applying-answer").removeClass("applying-answer")},onRequiredProductSelectionsMissing:function(){},onRequiredProductSelectionsMade:function(){},onRequiredPageSelectionsMissing:function(){!0===d.getConfiguratorData("blockNavigationOnMissing")&&a(".add-to-cart-button, .cb-page-nav-next").addClass("configbox-disabled")},
onRequiredPageSelectionsMade:function(){a(".add-to-cart-button, .cb-page-nav-next").removeClass("configbox-disabled")},onChangeCurrency:function(){a(this).closest("form").submit()},registeredQuestionTypes:{},registerQuestion:function(a,b){var e="init onQuestionActivation onQuestionDeactivation onAnswerActivation onAnswerDeactivation onSystemSelectionChange onValidationChange onValidationMessageShown onValidationMessageCleared".split(" "),f=[],g;for(g in e)e.hasOwnProperty(g)&&"function"!==typeof b[e[g]]&&
f.push(e[g]);if(f.length)throw'Your question type "'+a+'" is missing these methods: '+f.join(", ")+". Add them and try again, even if you do not need those. Look up what they do in the built-in question types.";d.registeredQuestionTypes[a]=b},getQuestionType:function(a){return this.registeredQuestionTypes[a]},initializedQuestionTypes:[],initQuestions:function(){cbrequire(["configbox/server"],function(c){var b=["configbox/questions"];!0===c.config.requireCustomQuestionJs&&b.push("configbox/custom/custom_questions");
cbrequire(b,function(){a(".kenedo-view.view-configuratorpage .question").each(function(){var b=a(this).data("questionType");if(!b)throw'The configurator page contains a question without a data-question-type attribute. Compare with the built-in question type templates and add it. The question with the problem has the ID "'+a(this).attr("id")+'"';var c=d.getQuestionType(b);if(!c)throw'The configurator page contains a question of type "'+b+'", but type object is not registered. Make sure you make and register it in custom_questions.js';
c.initEach&&c.initEach();-1===d.initializedQuestionTypes.indexOf(b)&&(d.initializedQuestionTypes.push(b),c.init(),a(document).on("cbQuestionActivation",c.onQuestionActivation),a(document).on("cbQuestionDeactivation",c.onQuestionDeactivation),a(document).on("cbAnswerActivation",c.onAnswerActivation),a(document).on("cbAnswerDeactivation",c.onAnswerDeactivation),a(document).on("cbSystemSelectionChange",c.onSystemSelectionChange),a(document).on("cbValidationChange",c.onValidationChange),a(document).on("cbValidationMessageShown",
c.onValidationMessageShown),a(document).on("cbValidationMessageCleared",c.onValidationMessageCleared))})})})},initBsPopovers:function(){a(".cb-popover").length&&cbrequire(["cbj","cbj.bootstrap"],function(a){a(".cb-popover").each(function(){var b={trigger:"undefined"!==typeof a(this).data("trigger")?a(this).data("trigger"):"hover",delay:"undefined"!==typeof a(this).data("delay")?a(this).data("delay"):200,html:"undefined"!==typeof a(this).data("html")?a(this).data("html"):!0};a(this).popover(b)});a(document).on("focus",
function(){a(".cb-popover").popover("hide")})})},initSelectionImageSwitcher:function(){a(document).on("click",".trigger-show-visualization",function(){a(".overviews").addClass("show-visualization").removeClass("show-selections")});a(document).on("click",".trigger-show-selections",function(){a(".overviews").addClass("show-selections").removeClass("show-visualization")})},initStickyBlock:function(){if(0!==a(".sticky-block").length){var c=a(".sticky-block"),b=c.offset(),e=c.height(),f=0,g=!1;!0!==d.stickyBlockHandlersAttached&&
(d.stickyBlockHandlersAttached=!0,window.setInterval(function(){e=c.height();b=c.offset();var d=null;c.closest(".row").children().each(function(){null!==d&&d!==a(this).offset().top&&(g=!0);d=a(this).offset().top;a(this).innerHeight()>f&&!a(this).find(".overviews").length&&(f=a(this).innerHeight())})},200),a(window).scroll(function(){if(0!==c.length)if(!0===g)c.css("padding-top",0);else{var d=a(window).scrollTop();d+20>b.top?(d=d-b.top+20,d+e<f-20&&c.css("padding-top",d),c.closest(".row").width()===
c.width()&&c.css("padding-top",0)):c.css("padding-top",0)}}))}},initDeferredPageNav:function(){var c,b,e;a(document).on("click",".wait-for-xhr",function(e){d.redirectUrl="";!0===c&&(e.preventDefault(),e.stopImmediatePropagation(),b=a(this).attr("href"))});a(".view-configuratorpage").closest("form").on("submit",function(b){!0===c&&(b.preventDefault(),b.stopImmediatePropagation(),e=a(this))});a(document).ajaxStart(function(){c=!0});a(document).ajaxStop(function(){c=!1;b?window.location.href=b:e&&(0!==
e.find("button[type=submit]").length?e.find("button[type=submit]").trigger("click"):e.trigger("submit"),e=null)})},initImagePreloading:function(){var c=function(b){b||(b=a(".cb-content"));b.find(".preload-image").each(function(b,c){var e=a(c).data("src");c.src!==e&&(c.src=e)})},b=window.setTimeout(c,500);a(document).ajaxStart(function(){window.clearTimeout(b)});a(document).ajaxStop(function(){b=window.setTimeout(c,500)});a("img:not(.preload-image)").on("load",function(){window.clearTimeout(b);b=window.setTimeout(c,
500)});a(document).on("cbQuestionActivation cbAnswerActivation",function(b,f){c(a("#question-"+f))})},sendSelectionToServer:function(c,b,e){a(document).trigger("serverRequestSent");d.blockVisualization.updateVisualization(c,parseInt(b));cbrequire(["configbox/server"],function(f){var g={languageTag:f.config.languageTag,questionId:c,selection:b,confirmed:e?"1":"0",cart_position_id:d.getCartPositionId(),productId:d.getProductId(),pageId:d.getPageId()};f.makeRequest("configuratorpage","makeSelection",
g).done(function(b){a(document).trigger("serverResponseReceived",[b])})})},processServerResponse:function(c,b){"undefined"!==typeof b.error?d.showValidationError(b.requestedChange.questionId,b.error):(d.clearValidationError(b.requestedChange.questionId),b.confirmationText?window.confirm(b.confirmationText)?d.sendSelectionToServer(b.requestedChange.questionId,b.requestedChange.selection,!0):d.updateSelection(b.originalValue.questionId,b.originalValue.selection,b.originalValue.outputValue,"system"):
(b.requestedChange&&d.updateSelection(b.requestedChange.questionId,b.requestedChange.selection,b.requestedChange.outputValue,"user"),b.validationValues&&d.processValidationUpdate(b.validationValues),b.itemVisibility&&d.processItemVisibility(b.itemVisibility),b.configurationChanges&&d.processAutomaticSelections(b.configurationChanges),b.pricing&&a(document).trigger("cbPricingChange",[b.pricing]),d.setConfiguratorDataItem("missingPageSelections",b.missingPageSelections),b.missingPageSelections.length?
a(document).trigger("cbRequiredPageSelectionsMissing",[b.missingPageSelections]):a(document).trigger("cbRequiredPageSelectionsMade"),d.setConfiguratorDataItem("missingProductSelections",b.missingProductSelections),b.missingProductSelections.length?a(document).trigger("cbRequiredProductSelectionsMissing",[b.missingProductSelections]):a(document).trigger("cbRequiredProductSelectionsMade")))},showValidationError:function(c,b){a(document).trigger("cbValidationMessageShown",[c,b])},clearValidationError:function(c){a(document).trigger("cbValidationMessageCleared",
[c])},updateSelection:function(c,b,e,f){"undefined"===typeof f&&(f="user");if("user"!==f&&"system"!==f)throw"selectedBy parameter is neither 'user' nor 'system'. Was '"+f+"'";a("#question-"+c).data("selection",b);a("#question-"+c).data("outputValue",e);"system"===f&&a(document).trigger("cbSystemSelectionChange",[c,b,e]);a(document).trigger("cbSelectionChange",[c,b,e])},processValidationUpdate:function(c){a.each(c,function(b,c){a(document).trigger("cbValidationChange",[b,c])})},processItemVisibility:function(c){var b=
d.getConfiguratorData("questions");a.each(c.questions,function(c,f){b[c].applies!==f&&((b[c].applies=f)?a(document).trigger("cbQuestionActivation",[c]):a(document).trigger("cbQuestionDeactivation",[c]))});a.each(c.answers,function(c,f){a.each(f,function(f,d){b[c].answers[f].applies!==d&&((b[c].answers[f].applies=d)?a(document).trigger("cbAnswerActivation",[c,f]):a(document).trigger("cbAnswerDeactivation",[c,f]))})})},processAutomaticSelections:function(c){c.remove&&a.each(c.remove,function(a){d.updateSelection(a,
null,null,"system")});c.add&&a.each(c.add,function(a,c){d.updateSelection(a,c.selection,c.outputValue,"system")})},updateAnswerPrices:function(c,b){a.each(b.questions,function(b,c){a(".question-price-"+b).html(c.priceFormatted);0===c.price?a(".question-price-"+b).closest(".question-price-wrapper").hide():a(".question-price-"+b).closest(".question-price-wrapper").show();a(".question-price-recurring-"+b).html(c.priceRecurringFormatted);0===c.priceRecurring?a(".question-price-recurring-"+b).closest(".question-price-recurring-wrapper").hide():
a(".question-price-recurring-"+b).closest(".question-price-recurring-wrapper").show()});a.each(b.answers,function(b,c){a(".answer-price-"+b).html(c.priceFormatted);0===c.price?a(".answer-price-"+b).closest(".answer-price-wrapper").hide():a(".answer-price-"+b).closest(".answer-price-wrapper").show();a(".answer-price-recurring-"+b).html(c.priceRecurringFormatted);0===c.priceRecurring?a(".answer-price-recurring-"+b).closest(".answer-price-recurring-wrapper-recurring").hide():a(".answer-price-recurring-"+
b).closest(".answer-price-recurring-wrapper").show()})},getCurrentSelection:function(c){return a("#question-"+c).data("selection")},getCartPositionId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("cart-position-id"))},getProductId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("product-id"))},getPageId:function(){return parseInt(a(".kenedo-view.view-configuratorpage").data("page-id"))},getConfiguratorData:function(c){var b=a("#configurator-data").data("json");
if(c){if("undefined"===typeof b[c])throw'Could not find key "'+c+'" in configurator data.';return b[c]}return b},replaceConfiguratorData:function(c){a("#configurator-data").data("json",c)},setConfiguratorDataItem:function(c,b){a("#configurator-data").data("json")[c]=b},questionHasProperty:function(a,b){return"undefined"!==typeof d.getConfiguratorData("questions")[a][b]},getQuestionPropValue:function(a,b){var e=d.getConfiguratorData("questions");if("undefined"===typeof e[a])throw'Question ID "'+a+
'" does not exist';if("undefined"===typeof e[a][b])throw'Questions do not have property "'+b+'"';return e[a][b]},blockPricing:{toggleSelectionsVisibility:function(){a(this).closest(".no-questions").length||(a(this).find(".pricing-configurator-page").slideToggle(100),a(this).closest(".configurator-page").find(".question-list").slideToggle(100,function(){a(this).closest(".configurator-page").toggleClass("configurator-page-expanded")}))},updatePricing:function(c,b){a(".pricing-regular .item-quantity").html(b.quantity);
a(".pricing-recurring .item-quantity").html(b.quantity);a(".pricing-regular .pricing-per-item-total").html(b.total.pricePerItemFormatted);a(".pricing-recurring .pricing-per-item-total").html(b.total.pricePerItemRecurringFormatted);a(".pricing-regular .pricing-total").html(b.total.priceFormatted);a(".pricing-recurring .pricing-total").html(b.total.priceRecurringFormatted);a.each(b.pages,function(b,c){var d=0!==c.price?c.priceFormatted:"";a(".pricing-regular .pricing-configurator-page-"+b).html(d);
d=c.priceRecurring?c.priceRecurringFormatted:"";a(".pricing-recurring .pricing-configurator-page-"+b).html(d)});a.each(b.questions,function(b,c){var d=0!==c.price?c.priceFormatted:"";a(".pricing-regular .pricing-question-"+b).html(d);d=0!==c.priceRecurring?c.priceRecurringFormatted:"";a(".pricing-recurring .pricing-question-"+b).html(d)});a(".pricing-regular .pricing-per-item-net").html(b.total.pricePerItemNetFormatted);a(".pricing-regular .pricing-per-item-tax").html(b.total.pricePerItemTaxFormatted);
a(".pricing-regular .pricing-per-item-gross").html(b.total.pricePerItemGrossFormatted);a(".pricing-recurring .pricing-per-item-net").html(b.total.pricePerItemRecurringNetFormatted);a(".pricing-recurring .pricing-per-item-tax").html(b.total.pricePerItemRecurringTaxFormatted);a(".pricing-recurring .pricing-per-item-gross").html(b.total.pricePerItemRecurringGrossFormatted);a(".pricing-regular .pricing-total-net").html(b.total.priceNetFormatted);a(".pricing-regular .pricing-total-tax").html(b.total.priceTaxFormatted);
a(".pricing-regular .pricing-total-gross").html(b.total.priceGrossFormatted);a(".pricing-recurring .pricing-total-net").html(b.total.priceRecurringNetFormatted);a(".pricing-recurring .pricing-total-tax").html(b.total.priceRecurringTaxFormatted);a(".pricing-recurring .pricing-total-gross").html(b.total.priceRecurringGrossFormatted);a(".pricing-total-plus-extras-net").html(b.totalPlusExtras.priceTaxFormatted);a(".pricing-total-plus-extras-tax").html(b.totalPlusExtras.priceNetFormatted);a(".pricing-total-plus-extras-gross").html(b.totalPlusExtras.priceGrossFormatted);
b.taxesFormatted&&a.each(b.taxesFormatted,function(b,c){a(".pricing-regular .pricing-taxrate-"+String(b).replace(".","-")).html(c)});b.delivery&&(a(".best-delivery-title").text(b.delivery.title),a(".pricing-total-delivery-net").html(b.delivery.priceNetFormatted),a(".pricing-total-delivery-tax").html(b.delivery.priceTaxFormatted),a(".pricing-total-delivery-gross").html(b.delivery.priceGrossFormatted),a(".delivery-cost").each(function(){0===b.delivery.priceGross?a(this).slideUp():a(this).slideDown()}));
b.payment&&(a(".best-payment-title").text(b.payment.title),a(".pricing-total-payment-net").html(b.payment.priceNetFormatted),a(".pricing-total-payment-tax").html(b.payment.priceTaxFormatted),a(".pricing-total-payment-gross").html(b.payment.priceGrossFormatted),a(".payment-cost").each(function(){0===b.payment.priceGross?a(this).slideUp():a(this).slideDown()}));a(".pricing-quantity").text(b.quantity);1<b.quantity?(a(".total-per-item").each(function(){"none"===a(this).css("display")&&a(this).slideDown(100)}),
a(".quantity-display").each(function(){"none"===a(this).css("display")&&a(this).slideDown(100)})):(a(".total-per-item").each(function(){"none"!==a(this).css("display")&&a(this).slideUp(100)}),a(".quantity-display").each(function(){"none"!==a(this).css("display")&&a(this).slideUp(100)}))},updateSelection:function(c,b,d,f){d?(a(".question-item-outputvalue-"+b).html(f),a(".hidden-item.question-item-"+b).slideDown(100,function(){a(this).removeClass("hidden-item")})):a(".question-item-"+b).slideUp(100,
function(){a(this).addClass("hidden-item")})}},blockVisualization:{updateVisualization:function(a,b,e){e?d.blockVisualization.changeImage(b,e):d.blockVisualization.removeImage(b)},removeImage:function(c){a(".image-question-id-"+c).fadeOut(200)},changeImage:function(c,b){if(parseInt(b)==b)if(b=parseInt(b),0!==b)if(0===a(".image-answer-id-"+b).length)a(".image-question-id-"+c+":not(.image-answer-id-"+b+")").fadeOut(200);else{a(".image-answer-id-"+b).fadeIn(200,"linear");var d=a(".image-question-id-"+
c+":not(.image-answer-id-"+b+")");d.length&&d.fadeOut(200,"linear")}else a(".image-answer-id-"+b).fadeOut(200)}}};return d});
