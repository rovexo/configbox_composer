define(["cbj","configbox/server","configbox/ga"],function(a,g,h){var e={initCheckoutPage:function(){h.getClientId(function(a){g.makeRequest("checkout","storeGaClientId",{gaClientId:a})});a(document).on("click",".trigger-show-order-address-form",function(){a(".wrapper-order-address .order-address-display").slideUp();a(".wrapper-order-address .order-address-form").slideDown()});a(document).on("click",".trigger-save-order-address",function(){a(this).addClass("processing");cbrequire(["configbox/customerform"],
function(b){var c=b.getCustomerFormData();g.storeOrderAddress(c).done(function(d){a(".trigger-save-order-address").removeClass("processing");!1===d.success?(0!==d.validationIssues.length&&b.displayValidationIssues(d.validationIssues),0!==d.errors.length&&window.alert(d.errors.join("\n"))):(a(".order-address-field").removeClass("invalid").removeClass("valid"),e.refreshOrderAddress(),e.refreshCartSummary(),e.refreshDeliveryOptions(),e.refreshPaymentOptions(),e.refreshOrderRecord(function(){var b={customerData:c,
orderData:e.getOrderMetaData()};a(document).trigger("cb.checkout.address_saved",b)}))})})});a(document).on("change","#subview-delivery .option-control",function(){a(this).closest("li").addClass("processing");var b=a(this).val();g.setDeliveryOption(b).done(function(){e.refreshPaymentOptions();e.refreshOrderRecord();e.refreshCartSummary();a("#subview-delivery li.processing").removeClass("processing");a(document).trigger("cb.checkout.delivery_saved")})});a(document).on("change","#subview-payment .option-control",
function(){a(this).closest("li").addClass("processing");var b=a(this).val();g.setPaymentOption(b).done(function(){e.refreshOrderRecord();e.refreshCartSummary();a("#subview-payment li.processing").removeClass("processing");a(document).trigger("cb.checkout.payment_saved")})});a(document).on("click",".trigger-show-terms",function(){cbrequire(["cbj.bootstrap"],function(){a("#modal-terms").modal()})});a(document).on("click",".trigger-show-refund-policy",function(){cbrequire(["cbj.bootstrap"],function(){a("#modal-refund-policy").modal()})});
a(document).on("click",".trigger-place-order",function(){var b=a(this);if(!0!==b.hasClass("processing")){b.addClass("processing");var c=!1,d=!1,f=a(this).closest(".view-checkout").data("agree-to-terms"),h=a(this).closest(".view-checkout").data("agree-to-rp"),k=a(this).closest(".view-checkout").data("text-agree-terms"),l=a(this).closest(".view-checkout").data("text-agree-rp"),m=a(this).closest(".view-checkout").data("text-agree-both");f&&!1===a("#agreement-terms").prop("checked")&&(c=!0);h&&!1===a("#agreement-refund-policy").prop("checked")&&
(d=!0);f="";c&&d&&(f=m);c&&!d&&(f=k);!c&&d&&(f=l);f?(a(this).removeClass("processing"),window.alert(f)):cbrequire(["configbox/customerform"],function(c){g.placeOrder().done(function(d){b.removeClass("processing");!1===d.success?window.alert(d.errors.join("\n")):(d={customerData:c.getCustomerFormData(),orderData:e.getOrderMetaData()},a(document).trigger("cb.checkout.order_placed",d),d=b.closest(".view-checkout").data("url-psp-view"),a(".wrapper-psp-bridge").load(d,function(){a(".trigger-redirect-to-psp").trigger("click")}))})})}});
a(document).on("click",".trigger-redirect-to-psp",function(){"undefined"!==typeof a(this).attr("href")?window.location=a(this).attr("href"):a(this).closest("form").submit()})},refreshOrderAddress:function(b){var c=a(".kenedo-view.view-checkout").data("url-address-view");a(".wrapper-order-address .order-address-display").load(c,function(){a(".wrapper-order-address .order-address-display").slideDown();a(".wrapper-order-address .order-address-form").slideUp();b&&b()})},refreshCartSummary:function(b){a(".kenedo-view.view-cart").data("url-cart-summary")&&
g.injectHtml(a(".wrapper-cart-summary"),"cart","reloadCartSummary",{},function(){a(".button-copy-product, .button-edit-product, .button-remove-product, .trigger-edit-quantity, .trigger-remove-position").hide();a("*[data-toggle=popover]").popover({trigger:"hover",delay:200,html:!0});b&&b()})},refreshDeliveryOptions:function(b){var c=a(".kenedo-view.view-checkout").data("url-delivery-view");a(".wrapper-delivery-options").load(c,{},function(){a(document).trigger("cbViewInjected");b&&b()})},refreshPaymentOptions:function(b){var c=
a(".kenedo-view.view-checkout").data("url-payment-view");a(".wrapper-payment-options").load(c,{},function(){a(document).trigger("cbViewInjected");b&&b()})},refreshOrderRecord:function(b){var c=a(".kenedo-view.view-checkout").data("url-order-view");a(".wrapper-order-record").load(c,{},function(){a(document).trigger("cbViewInjected");b&&b()})},getOrderMetaData:function(){var b=a(".kenedo-view.view-record #order-meta-data");if(0===b.length)throw"Cannot find order meta data script tag in view record. The template may need an update, compare with original template of view 'record'.";
return JSON.parse(b.text())}};return e});
