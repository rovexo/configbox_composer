define(["cbj","configbox/server","configbox/ga"],function(a,g,h){var d={initCheckoutPage:function(){h.getClientId(function(a){g.makeRequest("checkout","storeGaClientId",{gaClientId:a})});a(document).on("click",".trigger-show-order-address-form",function(){a(".wrapper-order-address .order-address-display").slideUp();a(".wrapper-order-address .order-address-form").slideDown()});a(document).on("click",".trigger-save-order-address",function(){a(this).addClass("processing");cbrequire(["configbox/customerform",
"configbox/server"],function(c,b){var e=c.getCustomerFormData();b.storeOrderAddress(e).done(function(b){a(".trigger-save-order-address").removeClass("processing");!1===b.success?(0!==b.validationIssues.length&&c.displayValidationIssues(b.validationIssues),0!==b.errors.length&&window.alert(b.errors.join("\n"))):(a(".order-address-field").removeClass("invalid").removeClass("valid"),d.refreshOrderAddress(),d.refreshCartSummary(),d.refreshDeliveryOptions(),d.refreshPaymentOptions(),d.refreshOrderRecord(function(){var c=
{customerData:e,orderData:d.getOrderMetaData()};a(document).trigger("cb.checkout.address_saved",c)}))})})});a(document).on("change","#subview-delivery .option-control",function(){a(this).closest("li").addClass("processing");var c=a(this).val();cbrequire(["configbox/server"],function(b){b.setDeliveryOption(c).done(function(){d.refreshPaymentOptions();d.refreshOrderRecord();d.refreshCartSummary();a("#subview-delivery li.processing").removeClass("processing");a(document).trigger("cb.checkout.delivery_saved")})})});
a(document).on("change","#subview-payment .option-control",function(){a(this).closest("li").addClass("processing");var c=a(this).val();cbrequire(["configbox/server"],function(b){b.setPaymentOption(c).done(function(){d.refreshOrderRecord();d.refreshCartSummary();a("#subview-payment li.processing").removeClass("processing");a(document).trigger("cb.checkout.payment_saved")})})});a(document).on("click",".trigger-show-terms",function(){cbrequire(["cbj.bootstrap"],function(){a("#modal-terms").modal()})});
a(document).on("click",".trigger-show-refund-policy",function(){cbrequire(["cbj.bootstrap"],function(){a("#modal-refund-policy").modal()})});a(document).on("click",".trigger-place-order",function(){var c=a(this);if(!0!==c.hasClass("processing")){c.addClass("processing");var b=!1,e=!1,f=a(this).closest(".view-checkout").data("agree-to-terms"),g=a(this).closest(".view-checkout").data("agree-to-rp"),h=a(this).closest(".view-checkout").data("text-agree-terms"),k=a(this).closest(".view-checkout").data("text-agree-rp"),
l=a(this).closest(".view-checkout").data("text-agree-both");f&&!1===a("#agreement-terms").prop("checked")&&(b=!0);g&&!1===a("#agreement-refund-policy").prop("checked")&&(e=!0);f="";b&&e&&(f=l);b&&!e&&(f=h);!b&&e&&(f=k);f?(a(this).removeClass("processing"),window.alert(f)):cbrequire(["configbox/server","configbox/customerform"],function(b,e){b.placeOrder().done(function(b){c.removeClass("processing");!1===b.success?window.alert(b.errors.join("\n")):(b={customerData:e.getCustomerFormData(),orderData:d.getOrderMetaData()},
a(document).trigger("cb.checkout.order_placed",b),b=c.closest(".view-checkout").data("url-psp-view"),a(".wrapper-psp-bridge").load(b,function(){a(".trigger-redirect-to-psp").trigger("click")}))})})}});a(document).on("click",".trigger-redirect-to-psp",function(){"undefined"!==typeof a(this).attr("href")?window.location=a(this).attr("href"):a(this).closest("form").submit()})},refreshOrderAddress:function(c){var b=a(".kenedo-view.view-checkout").data("url-address-view");a(".wrapper-order-address .order-address-display").load(b,
function(){a(".wrapper-order-address .order-address-display").slideDown();a(".wrapper-order-address .order-address-form").slideUp();c&&c()})},refreshCartSummary:function(c){var b=a(".kenedo-view.view-cart").data("url-cart-summary");b&&a(".wrapper-cart-summary").load(b,{},function(){a(".button-copy-product, .button-edit-product, .button-remove-product, .trigger-edit-quantity, .trigger-remove-position").hide();a("*[data-toggle=popover]").popover({trigger:"hover",delay:200,html:!0});c&&c()})},refreshDeliveryOptions:function(c){var b=
a(".kenedo-view.view-checkout").data("url-delivery-view");a(".wrapper-delivery-options").load(b,{},function(){a(document).trigger("cbViewInjected");c&&c()})},refreshPaymentOptions:function(c){var b=a(".kenedo-view.view-checkout").data("url-payment-view");a(".wrapper-payment-options").load(b,{},function(){a(document).trigger("cbViewInjected");c&&c()})},refreshOrderRecord:function(c){var b=a(".kenedo-view.view-checkout").data("url-order-view");a(".wrapper-order-record").load(b,{},function(){a(document).trigger("cbViewInjected");
c&&c()})},getOrderMetaData:function(){var c=a(".kenedo-view.view-record #order-meta-data");if(0===c.length)throw"Cannot find order meta data script tag in view record. The template may need an update, compare with original template of view 'record'.";return JSON.parse(c.text())}};return d});
