var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,f,d){b instanceof String&&(b=String(b));for(var c=b.length,a=0;a<c;a++){var e=b[a];if(f.call(d,e,a,b))return{i:a,v:e}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,f,d){b!=Array.prototype&&b!=Object.prototype&&(b[f]=d.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var f=0;f<b.length;++f){var d=b[f];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,f,d,c){if(f){d=$jscomp.global;b=b.split(".");for(c=0;c<b.length-1;c++){var a=b[c];a in d||(d[a]={});d=d[a]}b=b[b.length-1];c=d[b];f=f(c);f!=c&&null!=f&&$jscomp.defineProperty(d,b,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,d){return $jscomp.findInternal(this,b,d).v}},"es6","es3");
define(["cbj","configbox/configurator"],function(b,f){var d={getDataUri:function(a,b){var c=new window.Image;c.onload=function(){var a=document.createElement("canvas");a.width=this.naturalWidth;a.height=this.naturalHeight;a.getContext("2d").drawImage(this,0,0);b(a.toDataURL("image/png"))};c.src=a}},c={callbackFunctions:{},timeouts:{},messageListenerAdded:!1,parameterDefinitions:{},onceCallHasFinished:!1,initShapeDiverVisOnce:function(){c.addMessageListener();b(window).on("resize",c.setIframeHeight);
var a=c.getIframe();b(a).on("load",function(){b(document).on("cbSelectionChange",c.updateVisualization)});b(document).on("sdGeometryUpdateDone",c.setExternalTextures);c.onceCallHasFinished=!0},initShapeDiverVisEach:function(){var a=window.setInterval(function(){if(!0===c.onceCallHasFinished){c.setIframeHeight();var b=c.getIframe();b.src=b.dataset.src;window.clearInterval(a)}},100)},setIframeHeight:function(){var a=c.getIframe(),e=b(a).data("relative-height");e&&(e=parseInt(b(a).width())*parseFloat(e)/
100,b(a).css("height",e+"px"))},addMessageListener:function(){!0!==c.messageListenerAdded&&(c.messageListenerAdded=!0,b(window).on("message",this.onReceiveMessage))},updateVisualization:function(a,e,d){a=f.getQuestionPropValue(e,"is_shapediver_control");if(0!==a&&"0"!==a)if(a=f.getQuestionPropValue(e,"question_type"),"upload"===a){if(a=f.getQuestionPropValue(e,"shapediver_geometry_name")){var l=b("#question-"+e).data("file-contents");l?(0===b("#image-question-id-"+e).length&&b('<img alt="" src="about:blank" id="image-question-id-'+
e+'" data-question-id="'+e+'" data-geometry-name="'+a+'" />').appendTo(".view-sdvisualization .current-images"),b("#image-question-id-"+e).attr("src",l),console.log("Adding texture to geometry named "+a),c.sendMessage({command:"setExternalTexture",arguments:[a,l]})):(b("#image-question-id-"+e).remove(),console.log("Removing texture from geometry named "+a),c.sendMessage({command:"removeExternalTexture",arguments:[a]}))}}else{var g=f.getQuestionPropValue(e,"shapediver_parameter_id");if(""!==g){var h=
null,k=f.getQuestionPropValue(e,"answers");switch(a){case "colorpicker":d&&(h="0x"+d.replace("#","")+"ff");break;case "ralcolorpicker":d&&(a=d.replace("RAL ",""),h="0x"+b("#question-"+e).find(".ral-color[data-color-id="+a+"]").data("hex").replace("#","").toLowerCase()+"ff");break;default:h=k&&"undefined"!==typeof k[d]?k[d].shapediver_choice_value:d}c.getParameterDefinitions(function(a){if("undefined"===typeof a[g])throw"Parameter "+g+" not found in parameter definitions.";"Boolean"===a[g].type&&(h=
d&&"true"===k[d].shapediver_choice_value?!0:!1);c.setParameterValue(g,h)})}}},getParameterDefinitions:function(a){c.sendMessage({command:"getParameterDefinitions"},null,function(b){a(b.result)})},setExternalTextures:function(){b(".view-sdvisualization .current-images img").each(function(){var a=b(this).data("geometry-name"),e=b(this).attr("src");"data:"===e.substr(0,5)?c.sendMessage({command:"setExternalTexture",arguments:[a,e]}):d.getDataUri(e,function(b){c.sendMessage({command:"setExternalTexture",
arguments:[a,b]})})})},setParameterValue:function(a,b){console.log('Setting parameter ID "'+a+'" with value "'+b+'". Value type is '+typeof b);c.sendMessage({command:"setParameterValue",arguments:[a,b]})},sendMessage:function(a,b,d,f){console.log("Sending message with this payload:");console.log(a);var e=a.command;d&&(a.callbackId=e,c.callbackFunctions[e]=d);f&&(c.timeouts[e]=window.setTimeout(f,3E3));c.getIframe(b).contentWindow.postMessage(a,"https://app.shapediver.com")},onReceiveMessage:function(a){a=
a.data||a.originalEvent.data;if("undefined"!==typeof a.errorCode&&0!==a.errorCode)throw'Error received on iframe message response. "'+a.errorMessage+'"';a.hasOwnProperty("viewerMessage")&&"GeometryUpdateDone"===a.viewerMessage?(console.log("triggering sdGeometryUpdateDone"),b(document).trigger("sdGeometryUpdateDone")):(a.callbackId=a.command||null,console.log("Received message for command "+a.command+" with this data:"),console.log(a),a.callbackId&&("function"===typeof c.callbackFunctions[a.callbackId]&&
(c.callbackFunctions[a.callbackId](a),delete c.callbackFunctions[a.callbackId]),"undefined"!==typeof c.timeouts[a.callbackId]&&(window.clearTimeout(c.timeouts[a.callbackId]),delete c.timeouts[a.callbackId])))},getIframe:function(a){a||(a="shapediver-vis");return(a=window.document.getElementById(a))?a:null}};return c});
