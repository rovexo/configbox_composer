define(["cbj","configbox/configurator"],function(d,h){var m={getDataUri:function(a,b){var c=new window.Image;c.onload=function(){var a=document.createElement("canvas");a.width=this.naturalWidth;a.height=this.naturalHeight;a.getContext("2d").drawImage(this,0,0);b(a.toDataURL("image/png"))};c.src=a}},c={callbackFunctions:{},timeouts:{},messageListenerAdded:!1,parameterDefinitions:{},onceCallHasFinished:!1,initShapeDiverVisOnce:function(){c.addMessageListener();d(window).on("resize",c.setIframeHeight);
var a=c.getIframe();d(a).on("load",function(){d(document).on("cbSelectionChange",c.updateVisualization)});d(document).on("sdGeometryUpdateDone",c.setExternalTextures);c.onceCallHasFinished=!0},initShapeDiverVisEach:function(){var a=window.setInterval(function(){if(!0===c.onceCallHasFinished){c.setIframeHeight();var b=c.getIframe();b.src=b.dataset.src;window.clearInterval(a)}},100)},setIframeHeight:function(){var a=c.getIframe(),b=d(a).data("relative-height");b&&(b=parseInt(d(a).width())*parseFloat(b)/
100,d(a).css("height",b+"px"))},addMessageListener:function(){!0!==c.messageListenerAdded&&(c.messageListenerAdded=!0,d(window).on("message",this.onReceiveMessage))},updateVisualization:function(a,b,e){a=h.getQuestionPropValue(b,"is_shapediver_control");if(0!==a&&"0"!==a)if(a=h.getQuestionPropValue(b,"question_type"),"upload"===a){if(a=h.getQuestionPropValue(b,"shapediver_geometry_name")){var g=d("#question-"+b).data("file-contents");g?(0===d("#image-question-id-"+b).length&&d('<img src="about:blank" id="image-question-id-'+
b+'" data-question-id="'+b+'" data-geometry-name="'+a+'" />').appendTo(".view-sdvisualization .current-images"),d("#image-question-id-"+b).attr("src",g),console.log("Adding texture to geometry named "+a),c.sendMessage({command:"setExternalTexture",arguments:[a,g]})):(d("#image-question-id-"+b).remove(),console.log("Removing texture from geometry named "+a),c.sendMessage({command:"removeExternalTexture",arguments:[a]}))}}else{var f=h.getQuestionPropValue(b,"shapediver_parameter_id");if(""!==f){var k=
null,l=h.getQuestionPropValue(b,"answers");switch(a){case "colorpicker":e&&(k="0x"+e.replace("#","")+"ff");break;case "ralcolorpicker":e&&(a=e.replace("RAL ",""),k="0x"+d("#question-"+b).find(".ral-color[data-color-id="+a+"]").data("hex").replace("#","").toLowerCase()+"ff");break;default:k=l&&"undefined"!==typeof l[e]?l[e].shapediver_choice_value:e}c.getParameterDefinitions(function(a){if("undefined"===typeof a[f])throw"Parameter "+f+" not found in parameter definitions.";"Boolean"===a[f].type&&(k=
e&&"true"===l[e].shapediver_choice_value?!0:!1);c.setParameterValue(f,k)})}}},getParameterDefinitions:function(a){c.sendMessage({command:"getParameterDefinitions"},null,function(b){a(b.result)})},setExternalTextures:function(){d(".view-sdvisualization .current-images img").each(function(){var a=d(this).data("geometry-name"),b=d(this).attr("src");"data:"===b.substr(0,5)?c.sendMessage({command:"setExternalTexture",arguments:[a,b]}):m.getDataUri(b,function(b){c.sendMessage({command:"setExternalTexture",
arguments:[a,b]})})})},setParameterValue:function(a,b){console.log('Setting parameter ID "'+a+'" with value "'+b+'". Value type is '+typeof b);c.sendMessage({command:"setParameterValue",arguments:[a,b]})},sendMessage:function(a,b,d,g){console.log("Sending message with this payload:");console.log(a);var f=a.command;d&&(a.callbackId=f,c.callbackFunctions[f]=d);g&&(c.timeouts[f]=window.setTimeout(g,3E3));c.getIframe(b).contentWindow.postMessage(a,"https://www.shapediver.com")},onReceiveMessage:function(a){a=
a.data||a.originalEvent.data;if("undefined"!==typeof a.errorCode&&0!==a.errorCode)throw'Error received on iframe message response. "'+a.errorMessage+'"';a.hasOwnProperty("viewerMessage")&&"GeometryUpdateDone"===a.viewerMessage?(console.log("triggering sdGeometryUpdateDone"),d(document).trigger("sdGeometryUpdateDone")):(a.callbackId=a.command||null,console.log("Received message for command "+a.command+" with this data:"),console.log(a),a.callbackId&&("function"===typeof c.callbackFunctions[a.callbackId]&&
(c.callbackFunctions[a.callbackId](a),delete c.callbackFunctions[a.callbackId]),"undefined"!==typeof c.timeouts[a.callbackId]&&(window.clearTimeout(c.timeouts[a.callbackId]),delete c.timeouts[a.callbackId])))},getIframe:function(a){a||(a="shapediver-vis");return(a=window.document.getElementById(a))?a:null}};return c});
