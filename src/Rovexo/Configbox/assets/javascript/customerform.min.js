define(["cbj","cbj.chosen","cbj.bootstrap"],function(a){var k={initCustomerFormEach:function(){a(".view-customerform .cb-popover").popover();a(".view-customerform .chosen-dropdown").chosen({disable_search_threshold:10})},initCustomerForm:function(){a(document).on("change",".view-customerform .trigger-toggle-same-delivery",function(){if(!0===a(this).prop("checked"))a(this).closest(".customer-form-sections").removeClass("show-delivery-fields");else{if("undefined"===a(this).data("got-toggled")){a(this).data("got-toggled",
!0);var c=a(this).closest(".view-customerform").data("customer-fields"),d=a(this).closest(".view-customerform").find("#form_type").val(),b;for(b in c)if(c.hasOwnProperty(b)){var e=c[b];if("1"==e["show_"+d]&&a("#"+e.field_name).length&&a("#billing"+e.field_name).length){var f=a("#billing"+e.field_name).val();a("input[name="+e.field_name+"]").val(f)}}}a(this).closest(".customer-form-sections").addClass("show-delivery-fields")}});a(document).on("change",".recurring-customer-login #show-login",function(){var c=
a(this).closest(".recurring-customer-login").find(".login-wrapper").show();!0===a(this).prop("checked")?c.show():c.hide()});a(document).on("click",".recurring-customer-login .trigger-login",function(){if(!a(this).hasClass("processing")){a(this).addClass("processing");var c=a(this).closest(".recurring-customer-login");c.find(".feedback").text("");var d=c.find(".input-username").val(),b=c.find(".input-password").val();cbrequire(["configbox/server"],function(e){e.requestLogin(d,b).done(function(f){!1===
f.success?0!==c.find(".login-box .feedback").length?c.find(".login-box .feedback").text(f.errorMessage):window.alert(f.errorMessage):(a(document).trigger("cbLogin"),f=c.closest(".view-customerform").data("view-url"),c.closest(".view-customerform").load(f,function(){a(document).trigger("cbViewInjected")}))}).always(function(){c.find(".login-box .processing").removeClass("processing")})})}});a(document).on("click",".recurring-customer-login .trigger-recover-password",function(){var c=a(this).closest(".login-wrapper").find(".input-username").val();
c&&a(this).closest(".recurring-customer-login").find(".recover-box .input-username").val(c);a(this).closest(".recurring-customer-login").find(".login-box").hide();a(this).closest(".recurring-customer-login").find(".recover-box").show();a(this).closest(".recurring-customer-login").find(".change-password-box").hide()});a(document).on("click",".recurring-customer-login .trigger-cancel-recovery",function(){a(this).closest(".recurring-customer-login").find(".login-box").show();a(this).closest(".recurring-customer-login").find(".recover-box").hide();
a(this).closest(".recurring-customer-login").find(".change-password-box").hide()});a(document).on("keyup",".view-customerform .customer-field .form-control",function(){a(this).closest(".customer-field").removeClass("invalid")});a(document).on("change",".view-customerform .customer-field select",function(){a(this).closest(".customer-field").removeClass("invalid")});a(document).on("click",".recurring-customer-login .trigger-request-verification-code",function(){if(!a(this).hasClass("processing")){a(this).addClass("processing");
var c=a(this).closest(".recover-box").find(".input-username").val(),d=a(this).closest(".recurring-customer-login");d.find(".feedback").text("");cbrequire(["configbox/server"],function(b){b.requestPasswordChangeVerificationCode(c).done(function(e){!1===e.success?0!==d.find(".recover-box .feedback").length?d.find(".recover-box .feedback").text(e.errorMessage):window.alert(e.errorMessage):(d.find(".recover-box").hide(),d.find(".change-password-box").show())}).always(function(){d.find(".recover-box .processing").removeClass("processing")})})}});
a(document).on("click",".recurring-customer-login .trigger-change-password",function(){if(!a(this).hasClass("processing")){a(this).addClass("processing");var c=a(this).closest(".change-password-box").find(".input-verification").val(),d=a(this).closest(".change-password-box").find(".input-new-password").val(),b=a(this).closest(".recurring-customer-login");b.find(".feedback").text("");cbrequire(["configbox/server"],function(e){e.requestPasswordChange(c,d,!0).done(function(f){!1===f.success?a.each(f.errors,
function(h,g){b.find(".change-password-box .feedback").append("<div>"+g.message+"</div>")}):(f=b.closest(".view-customerform").data("view-url"),a(document).trigger("cbLogin"),b.closest(".view-customerform").load(f,function(){a(document).trigger("cbViewInjected")}))}).always(function(){b.find(".processing").removeClass("processing")})})}});a(document).on("keyup",".recurring-customer-login",function(c){if(13===c.which){var d=a(this).closest(".recurring-customer-login");c=a(c.target);0!==c.closest(".login-box").length&&
d.find(".trigger-login").trigger("click");0!==c.closest(".recover-box").length&&d.find(".trigger-request-verification-code").trigger("click");0!==c.closest(".change-password-box").length&&d.find(".trigger-change-password").trigger("click")}});a(document).on("change","select.updates-states",function(){a(this).trigger("chosen:updated");var c=parseInt(a(this).val()),d=a(this).data("state-select-id"),b=a("#"+d);0!==b.length&&(0===c?(b.html('<option value="0" selected="selected"></option>'),b.prop("disabled",
!0),b.trigger("chosen:updated").trigger("change")):cbrequire(["configbox/server"],function(e){e.makeRequest("customerform","getStates",{country_id:c}).done(function(f){b.html("").prop("disabled",!1);0===f.length?b.closest(".customer-field").addClass("has-no-data"):b.closest(".customer-field").removeClass("has-no-data");a.each(f,function(h,g){b.append('<option value="'+g.id+'">'+g.name+"</option>")});b.trigger("chosen:updated").trigger("change")})}))});a(document).on("change",".view-customerform select.updates-counties",
function(){a(this).trigger("chosen:updated");var c=parseInt(a(this).val()),d=a(this).data("county-select-id"),b=a("#"+d);0!==b.length&&(0===c?(b.html('<option value="0" selected="selected"></option>'),b.prop("disabled",!0),b.trigger("chosen:updated").trigger("change")):cbrequire(["configbox/server"],function(e){e.makeRequest("customerform","getCounties",{state_id:c}).done(function(f){b.html("").prop("disabled",!1);0===f.length?b.closest(".customer-field").addClass("has-no-data"):b.closest(".customer-field").removeClass("has-no-data");
a.each(f,function(h,g){b.append('<option value="'+g.id+'">'+g.county_name+"</option>")});b.trigger("chosen:updated").trigger("change")})}))});a(document).on("change",".view-customerform select.updates-cities",function(){a(this).trigger("chosen:updated");var c=parseInt(a(this).val()),d=a(this).data("city-select-id"),b=a("#"+d);if(0!==b.length)if(0===c){b.val("0").trigger("chosen:updated").trigger("change");b.closest(".customer-field").addClass("uses-textfield-instead");var e=d.replace("_id","");b.closest(".view-customerform").find(".customer-field-"+
e).removeClass("uses-dropdown-instead")}else cbrequire(["configbox/server"],function(f){f.makeRequest("customerform","getCities",{county_id:c}).done(function(h){b.html("").prop("disabled",!1);if(0===h.length)b.val("0").trigger("chosen:updated").trigger("change"),b.closest(".customer-field").addClass("uses-textfield-instead"),h=d.replace("_id",""),b.closest(".view-customerform").find(".customer-field-"+h).removeClass("uses-dropdown-instead");else{b.closest(".customer-field").removeClass("has-no-data uses-textfield-instead");
var g=d.replace("_id","");a("#"+g).val("");b.closest(".view-customerform").find(".customer-field-"+g).addClass("uses-dropdown-instead");a.each(h,function(m,l){b.append('<option value="'+l.id+'">'+l.city_name+"</option>")});b.trigger("change").trigger("chosen:updated")}})})})},getCustomerFormData:function(){var c={};a(".kenedo-view.view-customerform :input").each(function(d,b){d=a(b).attr("name");let e;a(b).attr("name")&&(a(b).is("input[type=radio]")?!0===a(b).prop("checked")&&(e=a(b).val()):e=a(b).is("input[type=checkbox]")?
!0===a(b).prop("checked")?"1":"0":a(b).val(),d&&void 0!==e&&(c[d]=e))});"1"===c.samedelivery&&a.each(c,function(d,b){0===d.indexOf("billing")&&(d=d.substr(7),"undefined"!==typeof c[d]&&(c[d]=b))});return c},displayValidationIssues:function(c){a(".view-customerform .customer-field:visible").removeClass("invalid").addClass("valid");for(var d in c)c.hasOwnProperty(d)&&(a(".customer-field-"+c[d].fieldName).removeClass("valid").addClass("invalid"),a(".customer-field-"+c[d].fieldName).find(".validation-tooltip").data("content",
c[d].message));k.initValidationTooltips()},removeValidationIssues:function(){a(".view-customerform .customer-field:visible").removeClass("invalid").removeClass("valid");a(".view-customerform .validation-tooltip").data("content","");k.initValidationTooltips()},initValidationTooltips:function(){a(".validation-tooltip").each(function(){var c={placement:"undefined"!==typeof a(this).data("placement")?a(this).data("placement"):"top",trigger:"undefined"!==typeof a(this).data("trigger")?a(this).data("trigger"):
"hover",delay:"undefined"!==typeof a(this).data("delay")?a(this).data("delay"):200,html:"undefined"!==typeof a(this).data("html")?a(this).data("html"):!0};a(this).popover(c)})}};return k});
