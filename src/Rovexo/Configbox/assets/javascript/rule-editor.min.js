var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,e,f){a instanceof String&&(a=String(a));for(var c=a.length,b=0;b<c;b++){var d=a[b];if(e.call(f,d,b,a))return{i:b,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,f){a!=Array.prototype&&a!=Object.prototype&&(a[e]=f.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,e,f,c){if(e){f=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var b=a[c];b in f||(f[b]={});f=f[b]}a=a[a.length-1];c=f[a];e=e(c);e!=c&&null!=e&&$jscomp.defineProperty(f,a,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,f){return $jscomp.findInternal(this,a,f).v}},"es6","es3");
define(["cbj","kenedo","configbox/server"],function(a,e,f){var c={initRuleEditor:function(){a.fn.makeDropZone=function(b){if("undefined"!==typeof b)var d=b;this.droppable({hoverClass:"drag-over",tolerance:"pointer",drop:function(b,c){b=a(c.helper).clone(!0,!0).removeClass("ui-draggable ui-draggable-dragging").removeAttr("style");"undefined"!==typeof d&&d.closest(".rule-area").length&&(a(c.draggable).draggable("option","revertDuration",0),d.remove());b.makeDraggableItem();a(this).replaceWith(b)}})};
a.fn.makeDraggableItem=function(){this.draggable({addClasses:!1,revert:!0,helper:"clone",opacity:.8,start:function(){a(this).closest(".rule-area").length&&a(this).hide();var b=a(this).closest(".view-adminruleeditor").find(".rule-area");b.find(".drop-area:not(.initial)").remove();a(this).draggable("option","revertDuration",100);if(0===b.find(".drop-area").length){if(0===b.find(".item").length)b.html('<span class="drop-area">&nbsp;</span>');else{var d="",c="";if(a(this).is(".condition")||a(this).is(".bracket"))d=
".combinator:first-child",c=".combinator";a(this).is(".combinator")&&(d=".condition + .condition, .bracket + .bracket, .condition + .bracket, .condition:first-child, .bracket:first-child",c=".condition:last-child, .bracket:last-child");if(!d||!c)throw"Could not figure out dropzone selectors.";b.find(d).before('<span class="drop-area">&nbsp;</span>');b.find(c).after('<span class="drop-area">&nbsp;</span>');b.find(".bracket:empty").html('<span class="drop-area">&nbsp;</span>')}0!==a(this).closest(".rule-area").length&&
a(this).after('<span class="drop-area">&nbsp;</span>');b.find(".drop-area, .parameter-drop-area").makeDropZone(a(this))}},stop:function(){var b=a(this).closest(".view-adminruleeditor").find(".rule-area");0!==b.find(".item").length&&b.find(".drop-area").remove();a(this).show()}});return this};a(".view-adminruleeditor .rule-area .item").makeDraggableItem();a(".view-adminruleeditor #combinator-blueprints .item").makeDraggableItem();a(".view-adminruleeditor .selected-panel .item").makeDraggableItem();
a(".view-adminruleeditor").on("panelSelected",function(){a(".view-adminruleeditor .selected-panel .item").makeDraggableItem()});a(".view-adminruleeditor .drop-area").makeDropZone();a(".view-adminruleeditor .rule-area").on("click",".item",function(b){b.shiftKey||a(this).closest(".rule-area").find(".selected").removeClass("selected");a(b.target).is(".input")||(a(b.target).is(".item")?a(b.target).addClass("selected"):0!==a(b.target).closest(".item").length&&a(b.target).closest(".item").addClass("selected"))});
a(".view-adminruleeditor").on("click",function(b){!1===a(b.target).is(".item")&&0===a(b.target).closest(".item").length&&a(this).closest(".view-adminruleeditor").find(".rule-area .selected").removeClass("selected")});a(".view-adminruleeditor").on("click",".button-limit-condition-width",function(){a(this).closest(".view-adminruleeditor").find(".rule-area").toggleClass("squeeze")});a(".view-adminruleeditor").on("click",".button-remove-selected-items",c.removeSelectedItems);a(".view-adminruleeditor").on("click",
".button-put-in-brackets",c.putInBrackets);a(document).keyup(function(a){switch(a.which){case 46:c.removeSelectedItems.apply(this,arguments)}a.preventDefault()});a(".view-adminruleeditor").on("click",".button-store",c.storeRule);a(".view-adminruleeditor").on("click",".button-cancel",function(){a(this).closest(".modal").modal("hide")});a(".view-adminruleeditor").on("click",".picker-tab",function(){var b=a(this).closest(".view-adminruleeditor"),d=a(this).attr("id");a(this).addClass("selected-tab").siblings().removeClass("selected-tab");
b.find(".picker-panels ."+d).addClass("selected-panel").siblings().removeClass("selected-panel");b.trigger("panelSelected",[d])});a(".view-adminruleeditor .condition input[type=text]").each(c.adjustTextFieldWidth);a(".view-adminruleeditor").on("keyup change click",".condition input[type=text]",c.adjustTextFieldWidth);a(".view-adminruleeditor").on("click",".condition-operator",function(){a(".condition .operator-picker").remove();("selectedOption.id"===a(this).closest(".condition").data("field")?a("#operator-picker-blueprint .operator-picker-short"):
a("#operator-picker-blueprint .operator-picker-full")).clone().appendTo(a(this))});a(".view-adminruleeditor").on("click",function(b){a(b.target).is(".condition-operator")||a(".condition .operator-picker").remove()});a(".view-adminruleeditor").on("click",".rule-area .operator, #condition-picker .operator",function(){var b=a(this).data("operator");a(this).closest(".condition").data("operator",b).attr("data-operator",b);a(this).closest(".condition-operator").text(a(this).text()+" ")});a(".view-adminruleeditor").on("change",
".page-filter select",function(){var b=parseInt(a(this).val());a(".question-picker li").removeClass("shown").removeClass("selected");a(0===b?".question-picker .question-list li":".question-picker .question-list li.page-"+b).addClass("shown");a("#question-filter").val("");a(".question-picker li.hidden-by-question-filter").removeClass("hidden-by-question-filter")});a("#question-filter").keyup(function(){var b=a(this).val();b=a.trim(b).toLowerCase();""===b&&a(".question-picker li").removeClass("hidden-by-question-filter");
a(".question-picker li.shown").each(function(){-1===a.trim(a(this).text()).toLowerCase().indexOf(b)?a(this).addClass("hidden-by-question-filter"):a(this).removeClass("hidden-by-question-filter")})});a(".view-adminruleeditor").on("click",".question-list li",function(){var b=a(this).data("question-id");a("#answer-group-"+b).show().siblings().hide();a("#question-attributes #answer-group-"+b+" .item").makeDraggableItem();a(this).addClass("picked").siblings().removeClass("picked");a("#question-attributes").show()})},
storeRule:function(){var b=a(this).closest(".view-adminruleeditor");b.find(".rule-area .drop-area").remove();var d=b.data("return-field-id"),g="",f=c.getRuleItems(b.find(".rule-area"));f.length&&(g=JSON.stringify(f).replace(/^"/g,"").replace(/"$/g,""));a("#"+d).val(g).trigger("change");b.find(".rule-area input").each(function(){a(this).replaceWith('<span class="condition-value">'+a(this).val()+"</span>")});a("#rule-text-"+d).html(b.find(".rule-area").html());g?a("#rule-text-"+d).closest(".rule-wrapper").addClass("has-rule").removeClass("has-no-rule"):
a("#rule-text-"+d).closest(".rule-wrapper").removeClass("has-rule").addClass("has-no-rule");a(this).closest(".modal").modal("hide")},getRuleItems:function(b){var d=[];b=b.children(".item");for(var g in b)if(!0===b.hasOwnProperty(g)&&!0!==isNaN(parseInt(g))){var f=c.getItemMetadata(a(b[g]));switch(f.type){case "bracket":d[g]=c.getRuleItems(a(b[g]));break;case "function":var e=a(b[g]).find(".parameter");f.parameters=[];for(var h in e)if(e.hasOwnProperty(h)&&!0!==isNaN(parseInt(g))){var k=c.getRuleItems(a(e[h]));
f.parameters.push(k)}d[g]=f;break;default:d[g]=f}}return d},getItemMetadata:function(b){var d=a(b).data(),c={},e;for(e in d)d.hasOwnProperty(e)&&"uiDraggable"!==e&&(c[e]=d[e]);a(b).find(".input").each(function(){var b=a(this).data("data-key");if(b){var d=a(this).val(),e=d.replace(f.config.decimalSymbol,".");e=Number(e);!1===isNaN(e)&&(d=e);c[b]=d}});return c},putInBrackets:function(){var b=a(this).closest(".view-adminruleeditor"),d=Math.ceil(2E4*Math.random());b.find(".selected").wrapAll('<span class="item bracket" data-type="bracket" id="bracket-'+
d+'" />');a("#bracket-"+d).makeDraggableItem().removeAttr("id");b.find(".rule-area .selected").removeClass("selected")},removeSelectedItems:function(){var b=a(this).closest(".view-adminruleeditor");b.find(".selected").each(function(){a(this).is(".bracket")&&a(this).children().detach().clone(!0,!0).insertAfter(a(this));a(this).next(".combinator").remove();a(this).is(":last-child")&&a(this).prev(".combinator").remove();a(this).remove()});b.find(".rule-editor .parameter").each(function(){var b=a(this);
if(0===b.find(".item").length){var c='<span class="parameter-drop-area">'+b.data("parameter-name")+"</span>";b.html(c)}})},adjustTextFieldWidth:function(){var b=""!==a(this).val()?a(this).val():a(this).attr("placeholder");a("#width-tester").text(b);a("#width-tester").css("font-size",a(this).css("font-size"));a("#width-tester").css("font-family",a(this).css("font-family"));b=parseInt(a("#width-tester").css("width"));10>b&&(b=10);b+=10;a(this).css("width",b+"px")}};return c});
