define(["cbj","kenedo","configbox/server"],function(a,m,k){var f={initRuleEditor:function(){a.fn.makeDropZone=function(b){if("undefined"!==typeof b)var c=b;this.droppable({hoverClass:"drag-over",tolerance:"pointer",drop:function(b,d){var g=a(d.helper).clone(!0,!0).removeClass("ui-draggable ui-draggable-dragging").removeAttr("style");"undefined"!==typeof c&&c.closest(".rule-area").length&&(a(d.draggable).draggable("option","revertDuration",0),c.remove());g.makeDraggableItem();a(this).replaceWith(g)}})};
a.fn.makeDraggableItem=function(){this.draggable({addClasses:!1,revert:!0,helper:"clone",opacity:.8,start:function(){a(this).closest(".rule-area").length&&a(this).hide();var b=a(this).closest(".view-adminruleeditor").find(".rule-area");b.find(".drop-area:not(.initial)").remove();a(this).draggable("option","revertDuration",100);if(0===b.find(".drop-area").length){if(0===b.find(".item").length)b.html('<span class="drop-area">&nbsp;</span>');else{var c="",e="";if(a(this).is(".condition")||a(this).is(".bracket"))c=
".combinator:first-child",e=".combinator";a(this).is(".combinator")&&(c=".condition + .condition, .bracket + .bracket, .condition + .bracket, .condition:first-child, .bracket:first-child",e=".condition:last-child, .bracket:last-child");if(!c||!e)throw"Could not figure out dropzone selectors.";b.find(c).before('<span class="drop-area">&nbsp;</span>');b.find(e).after('<span class="drop-area">&nbsp;</span>');b.find(".bracket:empty").html('<span class="drop-area">&nbsp;</span>')}0!==a(this).closest(".rule-area").length&&
a(this).after('<span class="drop-area">&nbsp;</span>');b.find(".drop-area, .parameter-drop-area").makeDropZone(a(this))}},stop:function(){var b=a(this).closest(".view-adminruleeditor").find(".rule-area");0!==b.find(".item").length&&b.find(".drop-area").remove();a(this).show()}});return this};a(".view-adminruleeditor .rule-area .item").makeDraggableItem();a(".view-adminruleeditor #combinator-blueprints .item").makeDraggableItem();a(".view-adminruleeditor .selected-panel .item").makeDraggableItem();
a(".view-adminruleeditor").on("panelSelected",function(){a(".view-adminruleeditor .selected-panel .item").makeDraggableItem()});a(".view-adminruleeditor .drop-area").makeDropZone();a(".view-adminruleeditor .rule-area").on("click",".item",function(b){b.shiftKey||a(this).closest(".rule-area").find(".selected").removeClass("selected");a(b.target).is(".input")||(a(b.target).is(".item")?a(b.target).addClass("selected"):0!==a(b.target).closest(".item").length&&a(b.target).closest(".item").addClass("selected"))});
a(".view-adminruleeditor").on("click",function(b){!1===a(b.target).is(".item")&&0===a(b.target).closest(".item").length&&a(this).closest(".view-adminruleeditor").find(".rule-area .selected").removeClass("selected")});a(".view-adminruleeditor").on("click",".button-limit-condition-width",function(){a(this).closest(".view-adminruleeditor").find(".rule-area").toggleClass("squeeze")});a(".view-adminruleeditor").on("click",".button-remove-selected-items",f.removeSelectedItems);a(".view-adminruleeditor").on("click",
".button-put-in-brackets",f.putInBrackets);a(document).keyup(function(a){switch(a.which){case 46:f.removeSelectedItems.apply(this,arguments)}a.preventDefault()});a(".view-adminruleeditor").on("click",".button-store",f.storeRule);a(".view-adminruleeditor").on("click",".button-cancel",function(){a(this).closest(".modal").modal("hide")});a(".view-adminruleeditor").on("click",".picker-tab",function(){var b=a(this).closest(".view-adminruleeditor"),c=a(this).attr("id");a(this).addClass("selected-tab").siblings().removeClass("selected-tab");
b.find(".picker-panels ."+c).addClass("selected-panel").siblings().removeClass("selected-panel");b.trigger("panelSelected",[c])});a(".view-adminruleeditor .condition input[type=text]").each(f.adjustTextFieldWidth);a(".view-adminruleeditor").on("keyup change click",".condition input[type=text]",f.adjustTextFieldWidth);a(".view-adminruleeditor").on("click",".condition-operator",function(){a(".condition .operator-picker").remove();("selectedOption.id"===a(this).closest(".condition").data("field")?a("#operator-picker-blueprint .operator-picker-short"):
a("#operator-picker-blueprint .operator-picker-full")).clone().appendTo(a(this))});a(".view-adminruleeditor").on("click",function(b){a(b.target).is(".condition-operator")||a(".condition .operator-picker").remove()});a(".view-adminruleeditor").on("click",".rule-area .operator, #condition-picker .operator",function(){var b=a(this).data("operator");a(this).closest(".condition").data("operator",b).attr("data-operator",b);a(this).closest(".condition-operator").text(a(this).text()+" ")});a(".view-adminruleeditor").on("change",
".page-filter select",function(){var b=parseInt(a(this).val());a(".question-picker li").removeClass("shown").removeClass("selected");a(0===b?".question-picker .question-list li":".question-picker .question-list li.page-"+b).addClass("shown");a("#question-filter").val("");a(".question-picker li.hidden-by-question-filter").removeClass("hidden-by-question-filter")});a("#question-filter").keyup(function(){var b=a(this).val(),b=a.trim(b).toLowerCase();""===b&&a(".question-picker li").removeClass("hidden-by-question-filter");
a(".question-picker li.shown").each(function(){-1===a.trim(a(this).text()).toLowerCase().indexOf(b)?a(this).addClass("hidden-by-question-filter"):a(this).removeClass("hidden-by-question-filter")})});a(".view-adminruleeditor").on("click",".question-list li",function(){var b=a(this).data("question-id");a("#answer-group-"+b).show().siblings().hide();a("#question-attributes #answer-group-"+b+" .item").makeDraggableItem();a(this).addClass("picked").siblings().removeClass("picked");a("#question-attributes").show()})},
storeRule:function(){var b=a(this).closest(".view-adminruleeditor");b.find(".rule-area .drop-area").remove();var c=b.data("return-field-id"),e="",d=f.getRuleItems(b.find(".rule-area")),g="1"===b.find(".rule-is-negated").val(),h;!0===g&&0<d.length?(h=b.find(".rule-is-negated option[value=1]").data("prefix-rule-text"),d.unshift({type:"negation"})):h=b.find(".rule-is-negated option[value=0]").data("prefix-rule-text");d.length&&(e=JSON.stringify(d).replace(/^"/g,"").replace(/"$/g,""));a("#"+c).val(e).trigger("change");
b.find(".rule-area input").each(function(){a(this).replaceWith('<span class="condition-value">'+a(this).val()+"</span>")});d="";g&&(d+=h+" ");d+=b.find(".rule-area").html();a("#rule-text-"+c).html(d);e?a("#rule-text-"+c).closest(".rule-wrapper").addClass("has-rule").removeClass("has-no-rule"):a("#rule-text-"+c).closest(".rule-wrapper").removeClass("has-rule").addClass("has-no-rule");a(this).closest(".modal").modal("hide")},getRuleItems:function(b){var c=[];b=b.children(".item");for(var e in b)if(!0===
b.hasOwnProperty(e)&&!0!==isNaN(parseInt(e))){var d=f.getItemMetadata(a(b[e]));switch(d.type){case "bracket":c[e]=f.getRuleItems(a(b[e]));break;case "function":var g=a(b[e]).find(".parameter");d.parameters=[];for(var h in g)if(g.hasOwnProperty(h)&&!0!==isNaN(parseInt(e))){var l=f.getRuleItems(a(g[h]));d.parameters.push(l)}c[e]=d;break;default:c[e]=d}}return c},getItemMetadata:function(b){var c=a(b).data(),e={},d;for(d in c)c.hasOwnProperty(d)&&"uiDraggable"!==d&&(e[d]=c[d]);a(b).find(".input").each(function(){var b=
a(this).data("data-key");if(b){var c=a(this).val(),d=c.replace(k.config.decimalSymbol,"."),d=Number(d);!1===isNaN(d)&&(c=d);e[b]=c}});return e},putInBrackets:function(){var b=a(this).closest(".view-adminruleeditor"),c=Math.ceil(2E4*Math.random());b.find(".selected").wrapAll('<span class="item bracket" data-type="bracket" id="bracket-'+c+'" />');a("#bracket-"+c).makeDraggableItem().removeAttr("id");b.find(".rule-area .selected").removeClass("selected")},removeSelectedItems:function(){var b=a(this).closest(".view-adminruleeditor");
b.find(".selected").each(function(){a(this).is(".bracket")&&a(this).children().detach().clone(!0,!0).insertAfter(a(this));a(this).next(".combinator").remove();a(this).is(":last-child")&&a(this).prev(".combinator").remove();a(this).remove()});b.find(".rule-editor .parameter").each(function(){var b=a(this);if(0===b.find(".item").length){var e='<span class="parameter-drop-area">'+b.data("parameter-name")+"</span>";b.html(e)}})},adjustTextFieldWidth:function(){var b=""!==a(this).val()?a(this).val():a(this).attr("placeholder");
a("#width-tester").text(b);a("#width-tester").css("font-size",a(this).css("font-size"));a("#width-tester").css("font-family",a(this).css("font-family"));b=parseInt(a("#width-tester").css("width"));10>b&&(b=10);b+=10;a(this).css("width",b+"px")}};return f});
