define(["cbj"],function(d){return{initBackendPropsOnce:function(){d(document).on("click",".trigger-load-model-data",function(){var a=d(this);if(!a.hasClass("processing")){a.addClass("processing");a.css("width",a.css("width"));a.data("ready-text",a.text());a.text(a.data("processing-text"));var c=d(this).closest(".property-type-shapedivermodel"),g=c.find(".model-url"),k=c.find(".model-parameters"),l=c.find(".model-textured-geometries"),f=c.find(".shapediver-iframe"),b=g.val();cbrequire(["configbox/shapediver"],
function(c){if("http"!==b.substr(0,4)){var e=/<iframe.*?src="(.*?)"/,h=e.exec(b);h&&"undefined"!==typeof h[1]?b=e.exec(b)[1]:(e=/<iframe.*?src='(.*?)'/,(h=e.exec(b))&&"undefined"!==typeof h[1]&&(b=e.exec(b)[1]))}e=b.indexOf("?");-1!==e&&(b=b.substr(0,e));g.val(b).change();c.addMessageListener();var m={doneJobs:[],requiredJobs:["getParameters","getTextures"],registerDoneJob:function(a){this.doneJobs.push(a);a=!1;for(var b in this.requiredJobs)this.requiredJobs.hasOwnProperty(b)&&-1===this.doneJobs.indexOf(this.requiredJobs[b])&&
(a=!0);!1===a&&this.doneCallback()},doneCallback:function(){a.text(a.data("done-text"));a.addClass("btn-success");window.setTimeout(function(){a.text(a.data("ready-text"));a.removeClass("btn-success");a.removeClass("processing")},1E3)}};f.on("load",function(){c.sendMessage({command:"getParameterDefinitions",arguments:[]},"shapediver-iframe",function(a){var b=[];0!==a.errorCode?window.alert("Cannot get parameter definitions from model. Error code is "+a.errorCode+" Error message is "+a.errorMessage+
". Assuming that there are no parameters in model."):b=a.result;for(var c in b)!0===b.hasOwnProperty(c)&&"undefined"===typeof b[c].type&&"undefined"!==typeof b[c].choices&&(b[c].type="choices");k.val(JSON.stringify(b)).change();m.registerDoneJob("getParameters")});d(document).on("sdGeometryUpdateDone",function(){c.sendMessage({command:"findTexturedGeometry",arguments:[]},"shapediver-iframe",function(a){var b=[];0!==a.errorCode?window.alert("Cannot get texturedGeometries from model. Error code is "+
a.errorCode+" Error message is "+a.errorMessage+". Assuming that there are no textures in model."):b=a.result;l.val(JSON.stringify(b)).change();m.registerDoneJob("getTextures")})})});b+="?version="+f.data("api-version");b!==f.attr("src")&&f.attr("src","about:blank");f.attr("src",b)})}});d(document).on("change",".model-parameters, .model-textured-geometries, .model-url, .model-ratio",function(){var a=d(this).closest(".property-type-shapedivermodel"),c=a.find(".model-url"),g=a.find(".model-parameters"),
k=a.find(".model-textured-geometries"),l=a.find(".model-ratio"),a=a.find(".shapediver-model-data"),c={iframeUrl:c.val(),ratioDimensions:l.val(),parameterData:JSON.parse(g.val()),texturedGeometries:JSON.parse(k.val())};a.val(JSON.stringify(c))});d(document).on("keyup",".model-ratio",function(){d(this).trigger("change")})}}});
