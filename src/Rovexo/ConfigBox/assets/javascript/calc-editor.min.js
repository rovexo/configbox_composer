var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,f,e){a instanceof String&&(a=String(a));for(var d=a.length,b=0;b<d;b++){var c=a[b];if(f.call(e,c,b,a))return{i:b,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,f,e){a!=Array.prototype&&a!=Object.prototype&&(a[f]=e.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,f,e,d){if(f){e=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var b=a[d];b in e||(e[b]={});e=e[b]}a=a[a.length-1];d=e[a];f=f(d);f!=d&&null!=f&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,e){return $jscomp.findInternal(this,a,e).v}},"es6","es3");
define(["cbj","kenedo","configbox/server"],function(a,f,e){f.registerSubviewReadyFunction("view-admincalcformula",function(){f.addStylesheet(e.config.urlSystemAssets+"/css/calc-editor.css?"+e.config.cacheVar);a.fn.makeDropZone=function(b){if("undefined"!==typeof b)var c=b;this.droppable({hoverClass:"drag-over",tolerance:"pointer",drop:function(b,d){b=a(d.helper).clone(!0,!0).removeClass("ui-draggable ui-draggable-dragging").removeAttr("style");"undefined"!==typeof c&&c.closest("#terms").length&&(a(d.draggable).draggable("option",
"revertDuration",0),c.remove());b.makeDraggableItem();a(this).replaceWith(b)}})};a.fn.makeDraggableItem=function(){this.draggable({addClasses:!1,revert:!0,helper:"clone",opacity:.8,start:function(){a(this).closest("#terms").length&&a(this).hide();a("#terms .drop-area").not(".initial").remove();a(this).draggable("option","revertDuration",100);var b="",c="";if(a(this).is(".term")||a(this).is(".bracket"))b=".operator:first-child",c=".operator";a(this).is(".operator")&&(b=".term + .term, .bracket + .bracket, .term + .bracket, .term:first-child, .bracket:first-child",
c=".term:last-child, .bracket:last-child");if(!b||!c)throw"Could not figure out dropzone selectors.";0===a("#terms .drop-area").length&&(a("#terms").find(b).before('<div class="drop-area">&nbsp;</div>'),a("#terms").find(c).after('<div class="drop-area">&nbsp;</div>'),a("#rule").find(".bracket:empty").html('<div class="drop-area">&nbsp;</div>'),0===a("#terms .term").length&&a("#terms").html('<div class="drop-area">&nbsp;</div>'),a(this).closest("#terms").length&&a(this).after('<div class="drop-area">&nbsp;</div>'),
a("#terms .drop-area").makeDropZone(a(this)),a("#terms .parameter-drop-area").makeDropZone(a(this)))},stop:function(){0!==a("#terms .item").length&&a("#terms .drop-area").remove();a(this).show()}});return this};a("#view-admincalcformula #terms .item").makeDraggableItem();a("#operator-blueprints .item, #custom-term-blueprints .item").makeDraggableItem();a("#view-admincalcformula .selected-panel .item").makeDraggableItem();a("#view-admincalcformula").on("panelSelected",function(){a("#view-admincalcformula .selected-panel .item").makeDraggableItem()});
a("#view-admincalcformula .drop-area").makeDropZone();a("#view-admincalcformula #terms").on("click",".item",function(b){b.shiftKey||a("#view-admincalcformula #terms .selected").removeClass("selected");a(b.target).is(".input")||(a(b.target).is(".item")?a(b.target).addClass("selected"):0!=a(b.target).closest(".item").length&&a(b.target).closest(".item").addClass("selected"))});a("#view-admincalcformula #terms").on("click",function(b){0==a(b.target).is(".item")&&0==a(b.target).closest(".item").length&&
a("#view-admincalcformula #terms .selected").removeClass("selected")});a("#view-admincalcformula").on("click",".button-limit-term-width",function(){a("#view-admincalcformula #rule").toggleClass("squeeze")});a("#view-admincalcformula").on("click",".button-remove-selected-items",function(){d.removeSelectedItems()});a("#view-admincalcformula").on("click",".button-put-in-brackets",function(){d.putInBrackets()});a(document).keyup(function(a){switch(a.which){case 46:d.removeSelectedItems()}a.preventDefault()});
a(".task-apply, .task-copy, .task-store").click(d.storeCalculation);a("#view-admincalcformula").on("click",".picker-tab",function(){var b=a(this).attr("id");a(this).addClass("selected-tab").siblings().removeClass("selected-tab");a(".picker-panels ."+b).addClass("selected-panel").siblings().removeClass("selected-panel");a("#view-admincalcformula").trigger("panelSelected",[b])});a("#view-admincalcformula .term input[type=text]").each(d.adjustTextFieldWidth);a("#view-admincalcformula").on("keyup change click",
".term input[type=text]",d.adjustTextFieldWidth);a("body").on("change","#view-admincalcformula .product-filter select",function(){var b=a(this).val();a(".page-filter-"+b).show().siblings().hide();a("#element-picker li").removeClass("shown").removeClass("selected");a("#element-picker .product-"+b).addClass("shown");a("#element-picker li.hidden-by-element-filter").removeClass("hidden-by-element-filter");a("#element-filter").val("")});a("body").on("change","#view-admincalcformula select.page-filter",
function(){var b=a("#product-filter").val(),c=a(this).val();a("#element-picker li").removeClass("shown").removeClass("selected");a(0==c?"#element-picker .product-"+b:"#element-picker .page-"+c+".product-"+b).addClass("shown");a("#element-picker li.hidden-by-element-filter").removeClass("hidden-by-element-filter");a("#element-filter").val("")});a("#element-filter").keyup(function(){var b=a(this).val();b=a.trim(b).toLowerCase();""==b&&a("#element-picker li").removeClass("hidden-by-element-filter");
a("#element-picker li.shown").each(function(){-1==a.trim(a(this).text()).toLowerCase().indexOf(b)?a(this).addClass("hidden-by-element-filter"):a(this).removeClass("hidden-by-element-filter")})});a("#view-admincalcformula #element-picker .element-list li").click(function(){var b=a(this).attr("id").replace("element-","");a("#xref-group-"+b).show().siblings().hide();a("#element-attributes #xref-group-"+b+" .item").makeDraggableItem();a(this).addClass("picked").siblings().removeClass("picked");a("#element-attributes").show()})});
var d={storeCalculation:function(){a("#view-admincalcformula #terms .drop-area").remove();var b=d.getCalcItems(a("#view-admincalcformula #terms"));b=JSON.stringify(b);a("#calc").val(b)},getCalcItems:function(b){var c=[];b.children(".item").each(function(){var b=a(this),e=d.getItemMetadata(b);switch(e.type){case "bracket":c.push(d.getCalcItems(b));break;case "function":e.parameters=[];a(b).find(".parameter").each(function(){var b=a(this);b=d.getCalcItems(b);e.parameters.push(b)});c.push(e);break;default:c.push(e)}});
return c},getItemMetadata:function(b){var c=a(b).data(),d={},f;for(f in c)c.hasOwnProperty(f)&&"uiDraggable"!==f&&(d[f]=c[f]);a(b).find(".input").each(function(){var b=a(this).val(),c=b.replace(e.config.decimalSymbol,".");c=Number(c);!1===isNaN(c)&&(b=c);c=a(this).data("data-key");d[c]=b});return d},putInBrackets:function(){var b=Math.ceil(2E4*Math.random());a("#view-admincalcformula .selected").wrapAll('<span class="item bracket" data-type="bracket" id="bracket-'+b+'" />');a("#bracket-"+b).makeDraggableItem().removeAttr("id");
a("#rule .selected").removeClass("selected")},removeSelectedItems:function(){a("#view-admincalcformula #terms .selected").each(function(){a(this).is(".bracket")&&a(this).children().detach().clone(!0,!0).insertAfter(a(this));a(this).next(".operator").remove();a(this).is(":last-child")&&a(this).prev(".operator").remove();a(this).remove()});a("#view-admincalcformula #terms .parameter").each(function(b,c){c=a(c);0===c.find(".item").length&&(b='<span class="parameter-drop-area">'+c.data("parameter-name")+
"</span>",c.html(b))})},adjustTextFieldWidth:function(){var b=""!=a(this).val()?a(this).val():a(this).attr("placeholder");a("#width-tester").text(b);a("#width-tester").css("font-size",a(this).css("font-size"));a("#width-tester").css("font-family",a(this).css("font-family"));b=parseInt(a("#width-tester").css("width"));10>b&&(b=10);b+=10;a(this).css("width",b+"px")}}});
