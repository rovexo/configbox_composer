var $jscomp={scope:{},findInternal:function(a,f,b){a instanceof String&&(a=String(a));for(var c=a.length,d=0;d<c;d++){var e=a[d];if(f.call(b,e,d,a))return{i:d,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,f,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[f]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,f,b,c){if(f){b=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var d=a[c];d in b||(b[d]={});b=b[d]}a=a[a.length-1];c=b[a];f=f(c);f!=c&&null!=f&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
define(["cbj","cbj.ui"],function(a){(function(a){a.widget("jb.dragtable",{eventWidgetPrefix:"dragtable",options:{dataHeader:"data-header",handle:"dragtable-drag-handle",items:"th:not( :has( .dragtable-drag-handle ) ), .dragtable-drag-handle",boundary:"dragtable-drag-boundary",placeholder:"dragtable-col-placeholder",appendTarget:":parent",scroll:!1},tableElemIndex:{head:"0",body:"1",foot:"2"},tbodyRegex:/(tbody|TBODY)/,theadRegex:/(thead|THEAD)/,tfootRegex:/(tfoot|TFOOT)/,_create:function(){this.endIndex=
this.startIndex=null;this.currentColumnCollection=[];this.currentColumnCollectionOffset={};this.dragDisplay=a([]);var b=this,c=b.options,d=b.element;c.appendTarget=":parent"===c.appendTarget?this.element.parent():a(c.appendTarget);d.delegate(c.items,"mousedown."+b.widgetEventPrefix,function(d){var e=a(this),n=b.element.position().top;e.hasClass(c.handle)&&(e=e.closest("th"),d.currentTarget=e.closest("th")[0]);b.getCol(e.index()).attr("tabindex",-1).focus().disableSelection().css({top:n,left:b.currentColumnCollectionOffset.left+
c.appendTarget[0].scrollLeft}).appendTo(c.appendTarget);b._mousemoveHandler(d)})},_mousemoveHandler:function(b){this._start(b);var c=this,d=c.options,e=b.pageX,g=c.dragDisplay.outerWidth(),n=g/2,l=d.scroll,h=c.element[0].getElementsByTagName("thead")[0].getElementsByTagName("tr")[0].getElementsByTagName("th").length-1;a(document).bind("mousemove."+c.widgetEventPrefix,function(b){var a=c._setCurrentColumnCollectionOffset(),k=b.pageX-e,f=d.appendTarget[0],m=parseInt(c.dragDisplay[0].style.left)+k;c.dragDisplay.css("left",
m);b.pageX<e?(a=a.left-n,m<f.clientWidth-g&&1==l&&(k=f.scrollLeft+k,"BODY"==f.tagName?window.scroll(window.scrollX+k,window.scrollY):f.scrollLeft=k),m<a&&c._swapCol(c.startIndex-1)):(a=a.left+n,m>f.clientWidth-g&&1==l&&(k=f.scrollLeft+k,"BODY"==f.tagName?window.scroll(window.scrollX+k,window.scrollY):f.scrollLeft=k),m>a&&h!=c.startIndex&&c._swapCol(c.startIndex+1));e=b.pageX}).one("mouseup."+c.widgetEventPrefix,function(b){c._stop(b)})},_start:function(b){a(document).disableSelection().css("cursor",
"move");this.dragDisplay.width(this.currentColumnCollection[0].clientWidth);return this._eventHelper("start",b)},_stop:function(b){a(document).unbind("mousemove."+this.widgetEventPrefix).enableSelection().css("cursor","");this.dropCol().dragDisplay.remove();this._eventHelper("stop",b,{})},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments)},_getCells:function(b,c){var d,a;d=this.tableElemIndex;var g={semantic:{0:[],1:[],2:[]},array:[]},f=this.theadRegex,l=this.tbodyRegex,
h=g.semantic[d.head],m=g.semantic[d.body],p=g.semantic[d.foot];if(-1>=c||"undefined"==typeof b.rows[0].cells[c])return g;for(var k=0,q=b.rows.length;k<q;k++)d=b.rows[k].cells[c],void 0!=d&&(a=d.parentNode.parentNode.nodeName,g.array.push(d),l.test(a)?m.push(d):f.test(a)?h.push(d):this.tfootRegex.test(a)&&p.push(d));return g},_getElementAttributes:function(b){var c=[];b=b.attributes;for(var a=0,e=b.length;a<e;a++)c.push(b[a].nodeName+'="'+b[a].value+'"');return c.join(" ")},_swapCells:function(b,a){b.parentNode.insertBefore(a,
b)},_eventHelper:function(b,c,d){return this._trigger(b,c,a.extend({column:this.currentColumnCollection,order:this.order(),startIndex:this.startIndex,endIndex:this.endIndex,dragDisplay:this.dragDisplay,columnOffset:this.currentColumnCollectionOffset},d))},getCol:function(b){var c,d,e,g,f,l=this.element,h=this,m=" "+this.options.placeholder;h.dragDisplay=a("<table "+h._getElementAttributes(l[0])+"></table>").addClass("dragtable-drag-col");h.startIndex=h.endIndex=b;b=h._getCells(l[0],b);h.currentColumnCollection=
b.array;a.each(b.semantic,function(b,a){if(0!=a.length)for(c="0"==b?document.createElement("thead"):1==b?document.createElement("tbody"):document.createElement("tfoot"),h.dragDisplay[0].appendChild(c),g=0,f=a.length;g<f;g++)d=a[g].cloneNode(!0),a[g].className+=m,e=document.createElement("tr"),e.appendChild(d),c.appendChild(e)});this._setCurrentColumnCollectionOffset();h.dragDisplay=a('<div class="dragtable-drag-wrapper"></div>').append(h.dragDisplay);return h.dragDisplay},_setCurrentColumnCollectionOffset:function(){return this.currentColumnCollectionOffset=
a(this.currentColumnCollection[0]).position()},_swapCol:function(b){if(b==this.startIndex)return!1;var a=this.startIndex;this.endIndex=b;var d=this.element.find("th").eq(b);if(1==d.hasClass(this.options.boundary)||1==d.find("."+this.options.handle).hasClass(this.options.boundary)||!1===this._eventHelper("beforeChange",{}))return!1;if(a<b)for(d=a;d<b;d++)for(var a=this._getCells(this.element[0],d+1),e=0,g=a.array.length;e<g;e++)this._swapCells(this.currentColumnCollection[e],a.array[e]);else for(d=
a;d>b;d--)for(a=this._getCells(this.element[0],d-1),e=0,g=a.array.length;e<g;e++)this._swapCells(a.array[e],this.currentColumnCollection[e]);this._eventHelper("change",{});this.startIndex=this.endIndex},dropCol:function(){for(var a=new RegExp("(?:^|\\s)"+this.options.placeholder+"(?!\\S)","g"),c=0,d=this.currentColumnCollection.length;c<d;c++){var e=this.currentColumnCollection[c];e.className=e.className.replace(a,"")}return this},order:function(b){var c=this.options,d=this.element.find("thead tr:first").children("th");
if(void 0==b){var e=[];d.each(function(){var b=this.getAttribute(c.dataHeader);null==b&&(b=a(this).text());e.push(b)});return e}if(b.length!=d.length)return this;for(var g=0,f=b.length;g<f;g++){var l=d.filter("["+c.dataHeader+"="+b[g]+"]").index();-1!=l&&(this.startIndex=l,this.currentColumnCollection=this._getCells(this.element[0],l).array,this._swapCol(g))}return this},destroy:function(){this.element.undelegate(this.options.items,"mousedown."+this.widgetEventPrefix);a(document).unbind("."+this.widgetEventPrefix)}})})(a);
return a});
